<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Quotidien</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0A2463;
            --primary-light: #1E3A8A;
            --accent: #FB8500;
            --accent-light: #FFB703;
            --success: #06D6A0;
            --danger: #EF476F;
            --bg-main: #F8FAFC;
            --bg-card: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --shadow-sm: 0 1px 3px rgba(10, 36, 99, 0.05);
            --shadow-md: 0 4px 12px rgba(10, 36, 99, 0.08);
            --shadow-lg: 0 10px 40px rgba(10, 36, 99, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header avec animation */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 30px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 183, 3, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-30px, -30px) scale(1.1); }
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-light);
        }

        .stat-label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Actions Bar */
        .actions-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Outfit', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(251, 133, 0, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
            background: var(--bg-card);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(10, 36, 99, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .filter-chip:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Table View */
        .table-container {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            border-bottom: 2px solid var(--border);
        }

        th {
            padding: 18px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: rgba(10, 36, 99, 0.05);
        }

        td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tbody tr {
            transition: all 0.2s;
            cursor: pointer;
        }

        tbody tr:hover {
            background: rgba(251, 133, 0, 0.03);
            transform: scale(1.001);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-particulier {
            background: rgba(6, 214, 160, 0.1);
            color: var(--success);
        }

        .status-professionnel {
            background: rgba(251, 133, 0, 0.1);
            color: var(--accent);
        }

        .status-association {
            background: rgba(10, 36, 99, 0.1);
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 36, 99, 0.4);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-card);
            border-radius: 24px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 30px 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 40px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
            background: var(--bg-card);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(10, 36, 99, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-footer {
            padding: 25px 40px;
            background: var(--bg-main);
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            border-top: 1px solid var(--border);
        }

        .btn-cancel {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border);
        }

        .btn-cancel:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-save {
            background: linear-gradient(135deg, var(--success) 0%, #05B894 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(6, 214, 160, 0.3);
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--danger) 0%, #D83654 100%);
            color: white;
            margin-right: auto;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 71, 111, 0.3);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .header-stats {
                width: 100%;
                justify-content: center;
            }

            .actions-bar {
                flex-direction: column;
            }

            .search-box {
                max-width: 100%;
            }
        }

        /* Scroll bar personnalis√© */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-main);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .delay-badge {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .delay-fast {
            background: rgba(6, 214, 160, 0.1);
            color: var(--success);
        }

        .delay-medium {
            background: rgba(251, 133, 0, 0.1);
            color: var(--accent);
        }

        .delay-slow {
            background: rgba(239, 71, 111, 0.1);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üìä Gestion des Demandes Quotidiennes</h1>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalCount">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgDelay">‚Äî</span>
                        <span class="stat-label">D√©lai Moyen</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions-bar">
            <button class="btn btn-primary" onclick="openModal()">
                <span>‚ûï</span> Nouvelle Demande
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher..." onkeyup="filterData()">
                <span class="search-icon">üîç</span>
            </div>
            <button class="btn btn-secondary" onclick="refreshData()">
                <span>üîÑ</span> Actualiser
            </button>
        </div>

        <div class="filters">
            <div class="filter-chip active" data-status="all" onclick="filterByStatus('all')">Tous</div>
            <div class="filter-chip" data-status="particulier" onclick="filterByStatus('particulier')">Particuliers</div>
            <div class="filter-chip" data-status="professionnel" onclick="filterByStatus('professionnel')">Professionnels</div>
            <div class="filter-chip" data-status="association" onclick="filterByStatus('association')">Associations</div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Chargement des donn√©es...</p>
        </div>

        <div class="table-container" id="tableContainer">
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Date Demande</th>
                            <th onclick="sortTable(1)">Statut</th>
                            <th onclick="sortTable(2)">Nom</th>
                            <th onclick="sortTable(3)">Sujet</th>
                            <th onclick="sortTable(4)">Direction</th>
                            <th onclick="sortTable(5)">Service</th>
                            <th onclick="sortTable(6)">D√©lai</th>
                            <th onclick="sortTable(7)">Date R√©ponse</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">üì≠</div>
                <h3>Aucune demande</h3>
                <p>Commencez par ajouter votre premi√®re demande</p>
                <button class="btn btn-primary" onclick="openModal()">
                    <span>‚ûï</span> Ajouter une demande
                </button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitle">Nouvelle Demande</h2>
                <button class="close-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="demandForm" class="form-grid">
                    <div class="form-group">
                        <label for="date_demande">Date de Demande *</label>
                        <input type="date" id="date_demande" required>
                    </div>
                    <div class="form-group">
                        <label for="statut">Statut *</label>
                        <select id="statut" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="particulier">Particulier</option>
                            <option value="professionnel">Professionnel</option>
                            <option value="association">Association</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="nom">Nom et Pr√©nom *</label>
                        <input type="text" id="nom" placeholder="Ex: Dupont Jean" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="sujet">Sujet de la Demande *</label>
                        <textarea id="sujet" placeholder="D√©crivez bri√®vement l'objet de la demande..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="direction">Direction *</label>
                        <select id="direction" onchange="updateServices()" required>
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="service">Service *</label>
                        <select id="service" onchange="updateMail()" required>
                            <option value="">-- S√©lectionner une direction d'abord --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date_charge">Date de Prise en Charge</label>
                        <input type="date" id="date_charge">
                    </div>
                    <div class="form-group">
                        <label for="date_reponse">Date de R√©ponse</label>
                        <input type="date" id="date_reponse">
                    </div>
                    <div class="form-group full-width">
                        <label for="mail">Mail de Contact</label>
                        <input type="email" id="mail" readonly placeholder="Sera rempli automatiquement">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-delete" id="deleteBtn" onclick="deleteRecord()" style="display: none;">
                    <span>üóëÔ∏è</span> Supprimer
                </button>
                <button class="btn btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn btn-save" onclick="saveRecord()">
                    <span>üíæ</span> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
        grist.ready();

        let currentData = [];
        let allDirections = [];
        let allServices = [];
        let currentFilter = 'all';
        let editingRowId = null;

        // Configuration de l'acc√®s aux donn√©es
        grist.onRecord(function(record) {
            // Ce widget fonctionne avec la liste compl√®te
        });

        // Initialisation
        async function init() {
            try {
                showLoading(true);
                
                // Charger les donn√©es de r√©f√©rence d'abord
                await loadDirections();
                await loadServices();
                
                console.log('Directions loaded:', allDirections.length);
                console.log('Services loaded:', allServices.length);
                
                // Puis charger les donn√©es principales
                await loadData();
                
                showLoading(false);
                updateStats();
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                showLoading(false);
                alert('Erreur lors du chargement. Veuillez actualiser la page.');
            }
        }

        // Charger toutes les donn√©es de QUOTIDIEN
        async function loadData() {
            try {
                const table = await grist.docApi.fetchTable('QUOTIDIEN');
                // Transformer les donn√©es en format utilisable
                currentData = [];
                if (table.id && table.id.length > 0) {
                    for (let i = 0; i < table.id.length; i++) {
                        currentData.push({
                            id: table.id[i],
                            date_demande: table.date_demande[i],
                            date_reponse: table.date_reponse[i],
                            date_charge: table.date_charge[i],
                            direction: table.direction[i],
                            service: table.service[i],
                            statut: table.statut[i],
                            nom: table.nom[i],
                            sujet: table.sujet[i],
                            delai: table.delai[i],
                            mail: table.mail[i]
                        });
                    }
                }
                renderTable();
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                console.log('Details:', error);
            }
        }

        // Charger les directions
        async function loadDirections() {
            try {
                const table = await grist.docApi.fetchTable('DIRECTIONS');
                // Transformer les donn√©es en format utilisable
                allDirections = [];
                for (let i = 0; i < table.id.length; i++) {
                    allDirections.push({
                        id: table.id[i],
                        direction: table.direction[i]
                    });
                }
                populateDirectionSelect();
            } catch (error) {
                console.error('Erreur lors du chargement des directions:', error);
                console.log('Details:', error);
            }
        }

        // Charger les services
        async function loadServices() {
            try {
                const table = await grist.docApi.fetchTable('SERVICES');
                // Transformer les donn√©es en format utilisable
                allServices = [];
                for (let i = 0; i < table.id.length; i++) {
                    allServices.push({
                        id: table.id[i],
                        service: table.service[i],
                        direction: table.direction[i],
                        mail: table.mail[i]
                    });
                }
            } catch (error) {
                console.error('Erreur lors du chargement des services:', error);
                console.log('Details:', error);
            }
        }

        // Remplir le select des directions
        function populateDirectionSelect() {
            const select = document.getElementById('direction');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            allDirections.forEach(dir => {
                const option = document.createElement('option');
                option.value = dir.id;
                option.textContent = dir.direction || 'Sans nom';
                select.appendChild(option);
            });
        }

        // Mettre √† jour les services en fonction de la direction
        function updateServices() {
            const directionId = parseInt(document.getElementById('direction').value);
            const serviceSelect = document.getElementById('service');
            
            serviceSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
            
            if (!directionId) {
                serviceSelect.innerHTML = '<option value="">-- S√©lectionner une direction d\'abord --</option>';
                document.getElementById('mail').value = '';
                return;
            }
            
            const filteredServices = allServices.filter(s => s.direction === directionId);
            
            filteredServices.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.service || 'Sans nom';
                option.dataset.mail = service.mail || '';
                serviceSelect.appendChild(option);
            });
        }

        // Mettre √† jour le mail en fonction du service
        function updateMail() {
            const serviceSelect = document.getElementById('service');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const mail = selectedOption.dataset.mail || '';
            document.getElementById('mail').value = mail;
        }

        // Afficher les donn√©es dans le tableau
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            
            let filteredData = currentData;
            
            // Filtre par statut
            if (currentFilter !== 'all') {
                filteredData = filteredData.filter(item => item.statut === currentFilter);
            }
            
            // Filtre par recherche
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredData = filteredData.filter(item => {
                    const directionName = getDirectionName(item.direction);
                    const serviceName = getServiceName(item.service);
                    return (
                        (item.nom || '').toLowerCase().includes(searchTerm) ||
                        (item.sujet || '').toLowerCase().includes(searchTerm) ||
                        (item.statut || '').toLowerCase().includes(searchTerm) ||
                        directionName.toLowerCase().includes(searchTerm) ||
                        serviceName.toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filteredData.map(item => {
                const directionName = getDirectionName(item.direction);
                const serviceName = getServiceName(item.service);
                const delayInfo = getDelayInfo(item.delai);
                
                return `
                    <tr onclick="editRecord(${item.id})">
                        <td>${formatDate(item.date_demande)}</td>
                        <td><span class="status-badge status-${item.statut || 'particulier'}">${item.statut || '‚Äî'}</span></td>
                        <td>${item.nom || '‚Äî'}</td>
                        <td>${truncateText(item.sujet, 50)}</td>
                        <td>${directionName}</td>
                        <td>${serviceName}</td>
                        <td>${delayInfo}</td>
                        <td>${formatDate(item.date_reponse)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Obtenir le nom de la direction
        function getDirectionName(directionId) {
            const direction = allDirections.find(d => d.id === directionId);
            return direction ? direction.direction : '‚Äî';
        }

        // Obtenir le nom du service
        function getServiceName(serviceId) {
            const service = allServices.find(s => s.id === serviceId);
            return service ? service.service : '‚Äî';
        }

        // Obtenir les infos du d√©lai
        function getDelayInfo(delai) {
            if (!delai && delai !== 0) return '‚Äî';
            
            let badgeClass = 'delay-medium';
            if (delai <= 3) badgeClass = 'delay-fast';
            else if (delai > 7) badgeClass = 'delay-slow';
            
            return `<span class="delay-badge ${badgeClass}">${delai}j</span>`;
        }

        // Formater une date
        function formatDate(dateValue) {
            if (!dateValue) return '‚Äî';
            try {
                const date = new Date(dateValue * 86400 * 1000); // Grist stocke les dates en jours depuis epoch
                return date.toLocaleDateString('fr-FR');
            } catch (e) {
                return '‚Äî';
            }
        }

        // Tronquer un texte
        function truncateText(text, maxLength) {
            if (!text) return '‚Äî';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            document.getElementById('totalCount').textContent = currentData.length;
            
            const validDelays = currentData.filter(item => item.delai !== null && item.delai !== undefined).map(item => item.delai);
            
            if (validDelays.length > 0) {
                const avgDelay = validDelays.reduce((a, b) => a + b, 0) / validDelays.length;
                document.getElementById('avgDelay').textContent = Math.round(avgDelay) + 'j';
            } else {
                document.getElementById('avgDelay').textContent = '‚Äî';
            }
        }

        // Filtrer par statut
        function filterByStatus(status) {
            currentFilter = status;
            
            // Mise √† jour des chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`[data-status="${status}"]`).classList.add('active');
            
            renderTable();
        }

        // Filtrer les donn√©es
        function filterData() {
            renderTable();
        }

        // Ouvrir le modal
        function openModal() {
            // V√©rifier que les directions sont charg√©es
            if (allDirections.length === 0) {
                alert('Chargement des donn√©es en cours... Veuillez patienter.');
                return;
            }
            
            editingRowId = null;
            document.getElementById('modalTitle').textContent = 'Nouvelle Demande';
            document.getElementById('deleteBtn').style.display = 'none';
            document.getElementById('demandForm').reset();
            document.getElementById('mail').value = '';
            
            // Repeupler les directions au cas o√π
            populateDirectionSelect();
            
            // Date du jour par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date_demande').value = today;
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        // √âditer un enregistrement
        async function editRecord(rowId) {
            editingRowId = rowId;
            const record = currentData.find(r => r.id === rowId);
            
            if (!record) {
                console.error('Record not found:', rowId);
                return;
            }
            
            console.log('Editing record:', record);
            
            document.getElementById('modalTitle').textContent = 'Modifier la Demande';
            document.getElementById('deleteBtn').style.display = 'inline-flex';
            
            // Remplir le formulaire
            document.getElementById('date_demande').value = convertGristDateToInput(record.date_demande);
            document.getElementById('statut').value = record.statut || '';
            document.getElementById('nom').value = record.nom || '';
            document.getElementById('sujet').value = record.sujet || '';
            document.getElementById('date_charge').value = convertGristDateToInput(record.date_charge);
            document.getElementById('date_reponse').value = convertGristDateToInput(record.date_reponse);
            
            // S√©lectionner la direction
            if (record.direction) {
                document.getElementById('direction').value = record.direction;
                // Charger les services pour cette direction
                updateServices();
                
                // Petit d√©lai pour s'assurer que les services sont charg√©s
                setTimeout(() => {
                    if (record.service) {
                        document.getElementById('service').value = record.service;
                        updateMail();
                    }
                }, 100);
            }
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        // Convertir une date Grist en format input
        function convertGristDateToInput(gristDate) {
            if (!gristDate) return '';
            try {
                const date = new Date(gristDate * 86400 * 1000);
                return date.toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        }

        // Convertir une date input en format Grist
        function convertInputDateToGrist(inputDate) {
            if (!inputDate) return null;
            try {
                const date = new Date(inputDate);
                return Math.floor(date.getTime() / (86400 * 1000));
            } catch (e) {
                return null;
            }
        }

        // Sauvegarder un enregistrement
        async function saveRecord() {
            const form = document.getElementById('demandForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const directionValue = document.getElementById('direction').value;
            const serviceValue = document.getElementById('service').value;
            
            if (!directionValue || !serviceValue) {
                alert('Veuillez s√©lectionner une direction et un service.');
                return;
            }
            
            const data = {
                date_demande: convertInputDateToGrist(document.getElementById('date_demande').value),
                statut: document.getElementById('statut').value || null,
                nom: document.getElementById('nom').value || null,
                sujet: document.getElementById('sujet').value || null,
                date_charge: convertInputDateToGrist(document.getElementById('date_charge').value),
                date_reponse: convertInputDateToGrist(document.getElementById('date_reponse').value),
                direction: parseInt(directionValue),
                service: parseInt(serviceValue)
            };
            
            console.log('Saving data:', data);
            
            try {
                if (editingRowId) {
                    // Mise √† jour
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', 'QUOTIDIEN', editingRowId, data]
                    ]);
                } else {
                    // Cr√©ation
                    await grist.docApi.applyUserActions([
                        ['AddRecord', 'QUOTIDIEN', null, data]
                    ]);
                }
                
                closeModal();
                await refreshData();
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                alert('Erreur lors de la sauvegarde: ' + error.message);
            }
        }

        // Supprimer un enregistrement
        async function deleteRecord() {
            if (!editingRowId) return;
            
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette demande ?')) {
                return;
            }
            
            try {
                await grist.docApi.applyUserActions([
                    ['RemoveRecord', 'QUOTIDIEN', editingRowId]
                ]);
                
                closeModal();
                await refreshData();
            } catch (error) {
                console.error('Erreur lors de la suppression:', error);
                alert('Erreur lors de la suppression. Veuillez r√©essayer.');
            }
        }

        // Fermer le modal
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            editingRowId = null;
        }

        // Fermer le modal en cliquant sur l'overlay
        function closeModalOnOverlay(event) {
            if (event.target.id === 'modalOverlay') {
                closeModal();
            }
        }

        // Actualiser les donn√©es
        async function refreshData() {
            showLoading(true);
            await loadData();
            await loadDirections();
            await loadServices();
            showLoading(false);
            updateStats();
        }

        // Afficher/masquer le loading
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const tableContainer = document.getElementById('tableContainer');
            
            if (show) {
                loading.classList.add('active');
                tableContainer.style.display = 'none';
            } else {
                loading.classList.remove('active');
                tableContainer.style.display = 'block';
            }
        }

        // Trier le tableau
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const ascending = sortDirection[columnIndex];
            
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                if (aText === '‚Äî' || aText === '') return 1;
                if (bText === '‚Äî' || bText === '') return -1;
                
                return ascending ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Initialiser au chargement
        init();
    </script>
</body>
</html>
