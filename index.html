<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√©unions</title>
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #181c27;
    --surface2: #1e2436;
    --border: #2a3050;
    --accent: #c9a84c;
    --accent2: #e8c87a;
    --text: #e8eaf0;
    --text-muted: #7a82a0;
    --text-light: #adb5cc;
    --danger: #e05c5c;
    --success: #5cba8a;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 24px rgba(0,0,0,0.4);
    --shadow-lg: 0 12px 48px rgba(0,0,0,0.6);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }

  .header-title {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--accent2);
    letter-spacing: 0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .header-title::before {
    content: '';
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, var(--accent), var(--accent2));
    border-radius: 2px;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .control-label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  select, input[type="text"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 7px 12px;
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  select:hover, input[type="text"]:hover { border-color: var(--accent); }
  select:focus, input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(201,168,76,0.15); }

  .search-box {
    width: 200px;
    padding-left: 32px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%237a82a0' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.099zm-5.44 1.346a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 10px center;
  }

  .count-badge {
    background: rgba(201,168,76,0.15);
    color: var(--accent);
    border: 1px solid rgba(201,168,76,0.3);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ LIST PANEL ‚îÄ‚îÄ */
  .list-panel {
    width: 380px;
    flex-shrink: 0;
    overflow-y: auto;
    border-right: 1px solid var(--border);
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .list-panel::-webkit-scrollbar { width: 4px; }
  .list-panel::-webkit-scrollbar-track { background: transparent; }
  .list-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ‚îÄ‚îÄ GROUP HEADER ‚îÄ‚îÄ */
  .group-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 12px 6px;
    cursor: pointer;
    user-select: none;
  }

  .group-toggle {
    color: var(--text-muted);
    font-size: 11px;
    transition: transform 0.2s;
    display: inline-block;
  }

  .group-toggle.collapsed { transform: rotate(-90deg); }

  .group-name {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    flex: 1;
  }

  .group-count {
    font-size: 11px;
    color: var(--text-muted);
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 1px 7px;
    border-radius: 10px;
  }

  .group-items { display: flex; flex-direction: column; gap: 2px; }
  .group-items.collapsed { display: none; }

  /* ‚îÄ‚îÄ MEETING CARD ‚îÄ‚îÄ */
  .meeting-card {
    padding: 12px 14px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.18s;
    border: 1px solid transparent;
    background: transparent;
    position: relative;
    overflow: hidden;
  }

  .meeting-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: transparent;
    border-radius: 2px 0 0 2px;
    transition: background 0.18s;
  }

  .meeting-card:hover {
    background: var(--surface);
    border-color: var(--border);
  }

  .meeting-card.active {
    background: var(--surface2);
    border-color: rgba(201,168,76,0.4);
  }

  .meeting-card.active::before { background: var(--accent); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 5px;
  }

  .card-objet {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    line-height: 1.3;
    flex: 1;
  }

  .card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .card-date {
    font-size: 12px;
    color: var(--text-muted);
  }

  .type-pill {
    font-size: 11px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 10px;
    white-space: nowrap;
  }

  .card-indicators {
    display: flex;
    gap: 6px;
    margin-top: 6px;
  }

  .indicator {
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 3px;
    color: var(--text-muted);
    padding: 2px 6px;
    background: rgba(255,255,255,0.04);
    border-radius: 4px;
  }

  .indicator.has-cr { color: var(--success); }
  .indicator.has-pdf { color: #7ab3e0; }

  /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
  .detail-panel {
    flex: 1;
    overflow-y: auto;
    padding: 28px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .detail-panel::-webkit-scrollbar { width: 4px; }
  .detail-panel::-webkit-scrollbar-track { background: transparent; }
  .detail-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text-muted);
    text-align: center;
  }

  .empty-icon {
    font-size: 48px;
    opacity: 0.3;
  }

  .empty-state p {
    font-size: 14px;
    color: var(--text-muted);
  }

  /* ‚îÄ‚îÄ DETAIL HEADER ‚îÄ‚îÄ */
  .detail-header {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .detail-type-date {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .detail-type-pill {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 14px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .detail-date {
    color: var(--text-muted);
    font-size: 13px;
  }

  .detail-objet {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 600;
    color: var(--text);
    line-height: 1.25;
  }

  /* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
  .section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
  }

  .section-line {
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* ‚îÄ‚îÄ COMPTE RENDU ‚îÄ‚îÄ */
  .cr-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    font-size: 14px;
    line-height: 1.8;
    color: var(--text-light);
    font-family: 'DM Sans', sans-serif;
    max-height: 420px;
    overflow-y: auto;
  }

  .cr-box::-webkit-scrollbar { width: 4px; }
  .cr-box::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Quill rendered content */
  .cr-box h1 { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--text); margin: 16px 0 8px; font-weight: 600; }
  .cr-box h2 { font-family: 'Playfair Display', serif; font-size: 17px; color: var(--text); margin: 14px 0 6px; font-weight: 600; }
  .cr-box h3 { font-size: 15px; color: var(--accent2); margin: 12px 0 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .cr-box p { margin: 4px 0; }
  .cr-box p:empty { height: 8px; }
  .cr-box strong { color: var(--text); font-weight: 600; }
  .cr-box em { font-style: italic; }
  .cr-box u { text-decoration: underline; text-underline-offset: 3px; }
  .cr-box s { text-decoration: line-through; color: var(--text-muted); }
  .cr-box ul { margin: 6px 0 6px 20px; padding: 0; list-style: disc; }
  .cr-box ol { margin: 6px 0 6px 20px; padding: 0; list-style: decimal; }
  .cr-box li { margin: 3px 0; }
  .cr-box ul ul, .cr-box ol ul { list-style: circle; margin-top: 2px; }
  .cr-box blockquote {
    border-left: 3px solid var(--accent);
    margin: 10px 0;
    padding: 4px 14px;
    color: var(--text-muted);
    font-style: italic;
    background: rgba(201,168,76,0.06);
    border-radius: 0 6px 6px 0;
  }
  .cr-box code {
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1px 6px;
    font-family: monospace;
    font-size: 12px;
    color: var(--accent2);
  }

  /* ‚îÄ‚îÄ ATTACHMENTS ‚îÄ‚îÄ */
  .attachments-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .attachment-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    transition: all 0.18s;
  }

  .attachment-item:hover {
    border-color: rgba(122,179,224,0.5);
    background: var(--surface2);
  }

  .attachment-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    background: rgba(122,179,224,0.1);
    flex-shrink: 0;
  }

  .attachment-info { flex: 1; min-width: 0; }

  .attachment-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .attachment-size {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .btn-open {
    background: rgba(122,179,224,0.12);
    border: 1px solid rgba(122,179,224,0.3);
    color: #7ab3e0;
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .btn-open:hover {
    background: rgba(122,179,224,0.22);
    border-color: rgba(122,179,224,0.6);
  }

  /* ‚îÄ‚îÄ PDF MODAL ‚îÄ‚îÄ */
  .pdf-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(6px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .pdf-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .pdf-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    width: 90vw;
    max-width: 1000px;
    height: 88vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translateY(16px) scale(0.98);
    transition: transform 0.25s;
  }

  .pdf-overlay.open .pdf-modal {
    transform: translateY(0) scale(1);
  }

  .pdf-modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    background: var(--surface2);
  }

  .pdf-modal-icon {
    font-size: 20px;
    flex-shrink: 0;
  }

  .pdf-modal-title {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pdf-modal-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .btn-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-light);
    padding: 6px 14px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.18s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-modal:hover {
    background: var(--surface2);
    border-color: var(--accent);
    color: var(--accent2);
  }

  .btn-modal-close {
    background: rgba(224,92,92,0.1);
    border-color: rgba(224,92,92,0.3);
    color: #e05c5c;
  }

  .btn-modal-close:hover {
    background: rgba(224,92,92,0.2);
    border-color: #e05c5c;
    color: #e05c5c;
  }

  .pdf-modal-body {
    flex: 1;
    position: relative;
    background: #525659;
  }

  .pdf-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  .pdf-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    color: var(--text-muted);
    font-size: 14px;
    background: var(--surface);
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .pdf-loading.hidden { opacity: 0; }

  .pdf-error {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 14px;
    color: var(--text-muted);
    font-size: 14px;
    background: var(--surface);
    text-align: center;
    padding: 40px;
  }

  .pdf-error-icon { font-size: 40px; opacity: 0.4; }
  .pdf-error p { max-width: 340px; line-height: 1.6; }
  .pdf-error small { font-size: 11px; color: var(--text-muted); opacity: 0.7; }

  /* ‚îÄ‚îÄ LOADING / ERROR ‚îÄ‚îÄ */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    font-size: 14px;
    gap: 10px;
  }

  .spinner {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .no-results {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
  }

  /* ‚îÄ‚îÄ SCROLLBARS global ‚îÄ‚îÄ */
  * { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  .meeting-card { animation: fadeIn 0.15s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

  .detail-panel > * { animation: slideIn 0.2s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateX(8px); } to { opacity: 1; transform: translateX(0); } }
</style>
</head>
<body>

<div class="header">
  <div class="header-title">R√©unions</div>
  <div class="header-controls">
    <input type="text" class="search-box" id="searchInput" placeholder="Rechercher‚Ä¶" oninput="render()">
    <div class="control-group">
      <span class="control-label">Grouper</span>
      <select id="groupBy" onchange="render()">
        <option value="none">Aucun</option>
        <option value="type" selected>Par type</option>
        <option value="month">Par mois</option>
        <option value="year">Par ann√©e</option>
      </select>
    </div>
    <div class="control-group">
      <span class="control-label">Tri</span>
      <select id="sortOrder" onchange="render()">
        <option value="desc">Plus r√©cent</option>
        <option value="asc">Plus ancien</option>
      </select>
    </div>
    <div class="count-badge" id="countBadge">0</div>
  </div>
</div>

<div class="main">
  <div class="list-panel" id="listPanel">
    <div class="loading"><div class="spinner"></div> Chargement‚Ä¶</div>
  </div>
  <div class="detail-panel" id="detailPanel">
    <div class="empty-state">
      <div class="empty-icon">üìã</div>
      <p>S√©lectionnez une r√©union<br>pour afficher son d√©tail</p>
    </div>
  </div>
</div>

<script>
  /* ‚îÄ‚îÄ STATE ‚îÄ‚îÄ */
  let allRecords = [];
  let selectedId = null;
  let collapsedGroups = new Set();
  let typeColors = {};
  const PALETTE = [
    ['rgba(201,168,76,0.15)', '#c9a84c'],
    ['rgba(92,186,138,0.15)', '#5cba8a'],
    ['rgba(122,179,224,0.15)', '#7ab3e0'],
    ['rgba(224,92,92,0.15)', '#e05c5c'],
    ['rgba(180,122,224,0.15)', '#b47ae0'],
    ['rgba(224,160,92,0.15)', '#e0a05c'],
    ['rgba(92,180,224,0.15)', '#5cb4e0'],
    ['rgba(224,200,92,0.15)', '#e0c85c'],
  ];
  let paletteIndex = 0;

  function getTypeColor(type) {
    if (!typeColors[type]) {
      typeColors[type] = PALETTE[paletteIndex % PALETTE.length];
      paletteIndex++;
    }
    return typeColors[type];
  }

  /* ‚îÄ‚îÄ GRIST INIT ‚îÄ‚îÄ */
  grist.ready({ requiredAccess: 'read table' });

  grist.onRecords((records) => {
    allRecords = records;
    render();
  });

  grist.onRecord((record) => {
    // optional: highlight selected record from table
  });

  /* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
  function formatDate(ts) {
    if (!ts) return '‚Äî';
    const d = ts > 99999 ? new Date(ts * 1000) : new Date(ts);
    return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' });
  }

  function formatDateShort(ts) {
    if (!ts) return '‚Äî';
    const d = ts > 99999 ? new Date(ts * 1000) : new Date(ts);
    return d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  function getMonth(ts) {
    if (!ts) return 'Sans date';
    const d = ts > 99999 ? new Date(ts * 1000) : new Date(ts);
    return d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  }

  function getYear(ts) {
    if (!ts) return 'Sans date';
    const d = ts > 99999 ? new Date(ts * 1000) : new Date(ts);
    return d.getFullYear().toString();
  }

  function getTypeLabel(r) {
    if (r.Type && typeof r.Type === 'object') return r.Type.Name || r.Type.Nom || Object.values(r.Type)[0] || 'Type';
    return r.Type || 'Sans type';
  }

  function hasAttachments(r) {
    return r['Pi√®ce_jointe'] && r['Pi√®ce_jointe'].length > 0
      || r['Piece_jointe'] && r['Piece_jointe'].length > 0
      || r.Attachments && r.Attachments.length > 0;
  }

  function getAttachments(r) {
    return r['Pi√®ce_jointe'] || r['Piece_jointe'] || r.Attachments || [];
  }

  function hasCR(r) {
    return r['Compte_rendu'] && r['Compte_rendu'].trim().length > 0
      || r['Compte rendu'] && r['Compte rendu'].trim().length > 0;
  }

  function getCR(r) {
    return r['Compte_rendu'] || r['Compte rendu'] || '';
  }

  /* ‚îÄ‚îÄ FILTER & SORT ‚îÄ‚îÄ */
  function getFiltered() {
    const q = document.getElementById('searchInput').value.toLowerCase().trim();
    const order = document.getElementById('sortOrder').value;

    let list = [...allRecords];

    if (q) {
      list = list.filter(r => {
        const objet = (r.Objet || '').toLowerCase();
        const type = getTypeLabel(r).toLowerCase();
        const cr = getCR(r).toLowerCase();
        return objet.includes(q) || type.includes(q) || cr.includes(q);
      });
    }

    list.sort((a, b) => {
      const da = a.Date || 0, db = b.Date || 0;
      return order === 'desc' ? db - da : da - db;
    });

    return list;
  }

  function groupRecords(list, groupBy) {
    if (groupBy === 'none') return [{ key: null, label: null, items: list }];
    const map = new Map();
    list.forEach(r => {
      let key;
      if (groupBy === 'type') key = getTypeLabel(r);
      else if (groupBy === 'month') key = getMonth(r.Date);
      else if (groupBy === 'year') key = getYear(r.Date);
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(r);
    });
    return Array.from(map.entries()).map(([key, items]) => ({ key, label: key, items }));
  }

  /* ‚îÄ‚îÄ RENDER LIST ‚îÄ‚îÄ */
  function render() {
    const filtered = getFiltered();
    const groupBy = document.getElementById('groupBy').value;
    const groups = groupRecords(filtered, groupBy);

    document.getElementById('countBadge').textContent = filtered.length;

    const panel = document.getElementById('listPanel');

    if (filtered.length === 0) {
      panel.innerHTML = '<div class="no-results">Aucune r√©union trouv√©e</div>';
      return;
    }

    let html = '';

    groups.forEach(({ key, label, items }) => {
      const collapsed = collapsedGroups.has(key);

      if (label !== null) {
        html += `<div class="group-header" onclick="toggleGroup('${key?.replace(/'/g, "\\'")}')">
          <span class="group-toggle ${collapsed ? 'collapsed' : ''}">‚ñº</span>
          <span class="group-name">${label}</span>
          <span class="group-count">${items.length}</span>
        </div>`;
      }

      html += `<div class="group-items ${collapsed ? 'collapsed' : ''}">`;

      items.forEach(r => {
        const typeLabel = getTypeLabel(r);
        const [bg, fg] = getTypeColor(typeLabel);
        const active = r.id === selectedId ? 'active' : '';
        const indicators = [];
        if (hasCR(r)) indicators.push(`<span class="indicator has-cr">‚ú¶ CR</span>`);
        const atts = getAttachments(r);
        if (atts.length > 0) indicators.push(`<span class="indicator has-pdf">üìé ${atts.length} fichier${atts.length > 1 ? 's' : ''}</span>`);

        html += `<div class="meeting-card ${active}" onclick="selectRecord(${r.id})">
          <div class="card-top">
            <div class="card-objet">${r.Objet || '(Sans objet)'}</div>
          </div>
          <div class="card-meta">
            <span class="type-pill" style="background:${bg};color:${fg}">${typeLabel}</span>
            <span class="card-date">${formatDateShort(r.Date)}</span>
          </div>
          ${indicators.length ? `<div class="card-indicators">${indicators.join('')}</div>` : ''}
        </div>`;
      });

      html += '</div>';
    });

    panel.innerHTML = html;
  }

  function toggleGroup(key) {
    if (collapsedGroups.has(key)) collapsedGroups.delete(key);
    else collapsedGroups.add(key);
    render();
  }

  /* ‚îÄ‚îÄ SELECT RECORD ‚îÄ‚îÄ */
  function selectRecord(id) {
    selectedId = id;
    render();
    renderDetail();
    try { grist.setSelectedRows([id]); } catch(e) {}
  }

  /* ‚îÄ‚îÄ RENDER DETAIL ‚îÄ‚îÄ */
  function renderDetail() {
    const panel = document.getElementById('detailPanel');
    const r = allRecords.find(x => x.id === selectedId);

    if (!r) {
      panel.innerHTML = `<div class="empty-state">
        <div class="empty-icon">üìã</div>
        <p>S√©lectionnez une r√©union<br>pour afficher son d√©tail</p>
      </div>`;
      return;
    }

    const typeLabel = getTypeLabel(r);
    const [bg, fg] = getTypeColor(typeLabel);
    const cr = getCR(r);
    const attachments = getAttachments(r);

    let html = `
    <div class="detail-header">
      <div class="detail-type-date">
        <span class="detail-type-pill" style="background:${bg};color:${fg}">${typeLabel}</span>
        <span class="detail-date">üìÖ ${formatDate(r.Date)}</span>
      </div>
      <div class="detail-objet">${r.Objet || '(Sans objet)'}</div>
    </div>`;

    if (cr && cr.trim()) {
      html += `
      <div class="section">
        <div class="section-header">
          <span class="section-title">Compte rendu</span>
          <div class="section-line"></div>
        </div>
        <div class="cr-box">${deltaToHtml(cr)}</div>
      </div>`;
    }

    if (attachments.length > 0) {
      html += `
      <div class="section">
        <div class="section-header">
          <span class="section-title">Pi√®ces jointes</span>
          <div class="section-line"></div>
        </div>
        <div class="attachments-grid">`;

      attachments.forEach((att, i) => {
        const name = typeof att === 'string' ? att : (att.name || att.filename || `Fichier ${i + 1}`);
        const isPdf = name.toLowerCase().endsWith('.pdf');
        const icon = isPdf ? 'üìÑ' : 'üìé';
        const size = att.size ? formatSize(att.size) : '';

        html += `
          <div class="attachment-item">
            <div class="attachment-icon">${icon}</div>
            <div class="attachment-info">
              <div class="attachment-name">${name}</div>
              ${size ? `<div class="attachment-size">${size}</div>` : ''}
            </div>
            <button class="btn-open" onclick="openAttachment(${r.id}, ${i}, '${name.replace(/'/g, "\\'")}')">
              ${isPdf ? '‚ñ∂ Ouvrir PDF' : '‚¨á T√©l√©charger'}
            </button>
          </div>`;
      });

      html += `</div></div>`;
    }

    if (!cr?.trim() && attachments.length === 0) {
      html += `<div class="no-results" style="padding:40px 0;color:var(--text-muted);font-size:13px;">
        Aucun compte rendu ni pi√®ce jointe pour cette r√©union.
      </div>`;
    }

    panel.innerHTML = html;
  }

  function escapeHtml(str) {
    return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  /* ‚îÄ‚îÄ QUILL DELTA ‚Üí HTML ‚îÄ‚îÄ */
  function deltaToHtml(raw) {
    let delta;
    if (typeof raw === 'string') {
      const trimmed = raw.trim();
      if (!trimmed) return '';
      if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
        try { delta = JSON.parse(trimmed); } catch(e) { return raw.split('\n').map(l => `<p>${escapeHtml(l)}</p>`).join(''); }
      } else {
        return raw.split('\n').map(l => `<p>${escapeHtml(l)}</p>`).join('');
      }
    } else { delta = raw; }

    const ops = delta.ops || (Array.isArray(delta) ? delta : []);
    if (!ops.length) return '';

    const lines = [];
    let currentLine = { segments: [], lineAttrs: {} };

    ops.forEach(op => {
      if (typeof op.insert !== 'string') return;
      const parts = op.insert.split('\n');
      parts.forEach((part, i) => {
        if (part.length > 0) currentLine.segments.push({ text: part, attrs: op.attributes || {} });
        if (i < parts.length - 1) {
          currentLine.lineAttrs = op.attributes || {};
          lines.push(currentLine);
          currentLine = { segments: [], lineAttrs: {} };
        }
      });
    });
    if (currentLine.segments.length > 0) lines.push(currentLine);

    let html = '';
    let listStack = [];

    function closeLists() {
      while (listStack.length > 0) { const t = listStack.pop(); html += t === 'bullet' ? '</ul>' : '</ol>'; }
    }

    function renderSegments(segs) {
      return segs.map(({ text, attrs }) => {
        let s = escapeHtml(text);
        if (!s) return '';
        if (attrs.bold) s = `<strong>${s}</strong>`;
        if (attrs.italic) s = `<em>${s}</em>`;
        if (attrs.underline) s = `<u>${s}</u>`;
        if (attrs.strike) s = `<s>${s}</s>`;
        if (attrs.code) s = `<code>${s}</code>`;
        if (attrs.link) s = `<a href="${escapeHtml(attrs.link)}" target="_blank" style="color:var(--accent2)">${s}</a>`;
        return s;
      }).join('');
    }

    lines.forEach(({ segments, lineAttrs }) => {
      const content = renderSegments(segments);
      const listType = lineAttrs.list;
      const indent = lineAttrs.indent || 0;
      const header = lineAttrs.header;
      const blockquote = lineAttrs.blockquote;

      if (listType) {
        const type = listType === 'ordered' ? 'ordered' : 'bullet';
        const tag = type === 'ordered' ? 'ol' : 'ul';
        if (listStack.length === 0 || listStack[listStack.length-1] !== type) {
          if (listStack.length > 0 && listStack[listStack.length-1] !== type) {
            const prev = listStack.pop(); html += prev === 'bullet' ? '</ul>' : '</ol>';
          }
          html += `<${tag}>`; listStack.push(type);
        }
        html += `<li>${content}</li>`;
      } else {
        closeLists();
        if (header) html += `<h${header}>${content}</h${header}>`;
        else if (blockquote) html += `<blockquote>${content}</blockquote>`;
        else html += `<p>${content}</p>`;
      }
    });

    closeLists();
    return html;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' o';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' Ko';
    return (bytes / 1048576).toFixed(1) + ' Mo';
  }

  /* ‚îÄ‚îÄ PDF MODAL ‚îÄ‚îÄ */
  let currentPdfUrl = null;

  async function openAttachment(rowId, attIndex, filename) {
    const isPdf = filename.toLowerCase().endsWith('.pdf');
    const url = await resolveAttachmentUrl(rowId, attIndex);
    if (!url) {
      alert('Impossible de r√©soudre l\'URL de ce fichier. V√©rifiez les permissions.');
      return;
    }
    if (isPdf) {
      openPdfModal(url, filename);
    } else {
      window.open(url, '_blank');
    }
  }

  async function resolveAttachmentUrl(rowId, attIndex) {
    // Method 1: Grist attachment API with access token
    try {
      const token = await grist.docApi.getAccessToken({ readOnly: true });
      const docId = await grist.getDocName();
      return `${window.location.origin}/api/docs/${docId}/attachments/${rowId}/${attIndex}/download?auth=${token.token || token}`;
    } catch(e) {}

    // Method 2: direct attachment object URL
    try {
      const record = allRecords.find(r => r.id === rowId);
      const att = getAttachments(record)[attIndex];
      if (att && att.url) return att.url;
    } catch(e) {}

    // Method 3: Grist getAttachmentUrl
    try {
      const record = allRecords.find(r => r.id === rowId);
      const att = getAttachments(record)[attIndex];
      const attId = att && (att.id || att.attachmentId || att.rowId);
      if (attId) {
        const url = await grist.docApi.getAttachmentDownloadUrl(attId);
        return url;
      }
    } catch(e) {}

    return null;
  }

  function openPdfModal(url, filename) {
    currentPdfUrl = url;
    document.getElementById('pdfModalTitle').textContent = filename;
    document.getElementById('pdfLoading').classList.remove('hidden');

    // Use PDF.js viewer embedded or direct iframe with #toolbar
    // Most browsers support native PDF rendering in iframe
    const iframe = document.getElementById('pdfIframe');
    iframe.src = '';

    // Small delay to allow loading indicator to show
    setTimeout(() => {
      // Append #toolbar=1&navpanes=0 for Chrome's native PDF viewer
      iframe.src = url + '#toolbar=1&navpanes=0&scrollbar=1';
    }, 50);

    document.getElementById('pdfOverlay').classList.add('open');
    document.addEventListener('keydown', onModalKeydown);
  }

  function closePdfModal(event) {
    // Close only if clicking overlay background or explicit close
    if (event && event.target !== document.getElementById('pdfOverlay')) return;
    _doClosePdfModal();
  }

  function _doClosePdfModal() {
    document.getElementById('pdfOverlay').classList.remove('open');
    setTimeout(() => {
      document.getElementById('pdfIframe').src = '';
      currentPdfUrl = null;
    }, 280);
    document.removeEventListener('keydown', onModalKeydown);
  }

  function onModalKeydown(e) {
    if (e.key === 'Escape') _doClosePdfModal();
  }

  function onIframeLoad() {
    document.getElementById('pdfLoading').classList.add('hidden');
  }

  function onIframeError() {
    const loading = document.getElementById('pdfLoading');
    loading.classList.add('hidden');
    // Show error fallback inside modal body
    const body = document.querySelector('.pdf-modal-body');
    const existing = body.querySelector('.pdf-error');
    if (!existing) {
      const err = document.createElement('div');
      err.className = 'pdf-error';
      err.innerHTML = `<div class="pdf-error-icon">‚ö†Ô∏è</div>
        <p>Impossible d'afficher ce PDF dans le navigateur.</p>
        <button class="btn-modal" onclick="downloadCurrentPdf()" style="margin-top:8px">‚¨á T√©l√©charger √† la place</button>
        <small>Certains navigateurs bloquent l'affichage int√©gr√© des PDF selon les restrictions de s√©curit√©.</small>`;
      body.appendChild(err);
    }
  }

  function downloadCurrentPdf() {
    if (currentPdfUrl) window.open(currentPdfUrl, '_blank');
  }
</script>
<!-- PDF MODAL -->
<div class="pdf-overlay" id="pdfOverlay" onclick="closePdfModal(event)">
  <div class="pdf-modal" id="pdfModal">
    <div class="pdf-modal-header">
      <span class="pdf-modal-icon">üìÑ</span>
      <span class="pdf-modal-title" id="pdfModalTitle">Document PDF</span>
      <div class="pdf-modal-actions">
        <button class="btn-modal" id="btnDownload" onclick="downloadCurrentPdf()">
          ‚¨á T√©l√©charger
        </button>
        <button class="btn-modal btn-modal-close" onclick="closePdfModal()">
          ‚úï Fermer
        </button>
      </div>
    </div>
    <div class="pdf-modal-body">
      <div class="pdf-loading" id="pdfLoading">
        <div class="spinner"></div>
        <span>Chargement du PDF‚Ä¶</span>
      </div>
      <iframe class="pdf-iframe" id="pdfIframe" title="Visualisation PDF"
        onload="onIframeLoad()" onerror="onIframeError()">
      </iframe>
    </div>
  </div>
</div>


</html>
