<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi de RÃ©unions</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- Grist Plugin SDK â€” injectÃ© automatiquement par Grist dans les custom widgets -->
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<style>
  :root {
    --bg: #0f0f11;
    --surface: #18181c;
    --surface2: #222228;
    --border: #2e2e38;
    --accent: #c8f04a;
    --accent2: #4af0c8;
    --accent3: #f04a8a;
    --text: #e8e8ee;
    --text-muted: #7a7a8c;
    --text-dim: #4a4a58;
    --status-todo: #f0a54a;
    --status-wip: #4a9ff0;
    --status-done: #c8f04a;
    --status-blocked: #f04a8a;
    --radius: 8px;
    --radius-lg: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ SETUP SCREEN (fallback si hors Grist) â”€â”€ */
  #setup-screen {
    display: none; /* cachÃ© par dÃ©faut, affichÃ© seulement hors contexte Grist */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 2rem;
    text-align: center;
    gap: 1.5rem;
  }
  #setup-screen h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2.8rem;
    line-height: 1.1;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  #setup-screen p { color: var(--text-muted); font-size: 1rem; max-width: 500px; }
  .field-group { display: flex; flex-direction: column; gap: .4rem; }

  /* â”€â”€ LOADER â”€â”€ */
  #loader {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    gap: 1.2rem;
  }
  .spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loader p { color: var(--text-muted); font-size: .9rem; }

  /* â”€â”€ MAIN APP â”€â”€ */
  #app { display: none; flex-direction: column; min-height: 100vh; }

  /* Header */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.2rem;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: .5rem;
  }
  .logo-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; display: inline-block; -webkit-text-fill-color: initial; }

  /* Nav tabs */
  nav { display: flex; gap: .25rem; }
  .tab {
    padding: .45rem .9rem;
    border-radius: 6px;
    font-size: .8rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border: 1px solid transparent;
    transition: all .15s;
    background: none;
  }
  .tab:hover { color: var(--text); background: var(--surface2); }
  .tab.active { color: var(--bg); background: var(--accent); border-color: var(--accent); }

  /* Header actions */
  .header-actions { display: flex; gap: .5rem; align-items: center; }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; gap: .4rem;
    padding: .5rem 1rem;
    border-radius: var(--radius);
    font-size: .82rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all .15s;
    font-family: 'DM Sans', sans-serif;
    white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { background: #d8ff5a; transform: translateY(-1px); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(240,74,138,.15); color: var(--accent3); border: 1px solid rgba(240,74,138,.3); }
  .btn-danger:hover { background: rgba(240,74,138,.25); }
  .btn-sm { padding: .3rem .6rem; font-size: .75rem; }
  .btn-icon { padding: .45rem; border-radius: 6px; background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all .15s; }
  .btn-icon:hover { color: var(--accent); border-color: var(--accent); }

  /* â”€â”€ PANELS â”€â”€ */
  .panel { display: none; flex: 1; }
  .panel.active { display: flex; flex-direction: column; }

  /* â”€â”€ PAGE LAYOUT â”€â”€ */
  .page-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .page-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.5rem; }
  .page-header p { color: var(--text-muted); font-size: .85rem; margin-top: .2rem; }

  /* â”€â”€ MEETINGS LIST â”€â”€ */
  .meetings-grid {
    padding: 1.5rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1rem;
  }
  .meeting-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all .2s;
    position: relative;
    overflow: hidden;
  }
  .meeting-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    opacity: 0;
    transition: opacity .2s;
  }
  .meeting-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,.4); }
  .meeting-card:hover::before { opacity: 1; }
  .meeting-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: .75rem; }
  .meeting-card h3 { font-size: .95rem; font-weight: 600; line-height: 1.3; }
  .meeting-card .meeting-date {
    font-family: 'DM Mono', monospace;
    font-size: .72rem;
    color: var(--text-muted);
    margin-top: .25rem;
  }
  .meeting-card-footer { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .75rem; align-items: center; }

  /* â”€â”€ BADGES â”€â”€ */
  .badge {
    display: inline-flex; align-items: center; gap: .3rem;
    padding: .2rem .55rem;
    border-radius: 100px;
    font-size: .72rem;
    font-weight: 500;
  }
  .badge-planned { background: rgba(74,159,240,.15); color: #4a9ff0; }
  .badge-active { background: rgba(200,240,74,.15); color: var(--accent); }
  .badge-done { background: rgba(74,240,200,.15); color: var(--accent2); }
  .badge-cancelled { background: rgba(74,74,88,.2); color: var(--text-dim); }

  /* Status badges for actions */
  .badge-todo { background: rgba(240,165,74,.15); color: var(--status-todo); }
  .badge-wip { background: rgba(74,159,240,.15); color: var(--status-wip); }
  .badge-blocked { background: rgba(240,74,138,.15); color: var(--status-blocked); }
  .badge-done-action { background: rgba(200,240,74,.15); color: var(--status-done); }

  /* Priority */
  .badge-high { background: rgba(240,74,138,.12); color: var(--accent3); }
  .badge-medium { background: rgba(240,165,74,.12); color: var(--status-todo); }
  .badge-low { background: rgba(74,74,88,.15); color: var(--text-muted); }

  /* â”€â”€ DETAIL VIEW â”€â”€ */
  #detail-view { display: none; flex-direction: column; min-height: 100vh; }
  .detail-header {
    display: flex; align-items: center; gap: 1rem;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    position: sticky; top: 0; z-index: 50;
  }
  .detail-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.3rem; flex: 1; }
  .detail-meta {
    display: flex; gap: 1.5rem; flex-wrap: wrap;
    padding: 1rem 1.5rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    font-size: .82rem;
    color: var(--text-muted);
  }
  .detail-meta span { display: flex; align-items: center; gap: .4rem; }
  .detail-meta strong { color: var(--text); }

  /* Tabs dans le dÃ©tail */
  .detail-tabs {
    display: flex; gap: .25rem;
    padding: .75rem 1.5rem;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
  }
  .detail-tab {
    padding: .4rem .8rem;
    border-radius: 6px;
    font-size: .8rem;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border: 1px solid transparent;
    transition: all .15s;
    background: none;
  }
  .detail-tab:hover { color: var(--text); }
  .detail-tab.active { color: var(--accent); border-color: var(--accent); }

  .detail-content { padding: 1.5rem; flex: 1; }

  /* â”€â”€ AGENDA ITEMS â”€â”€ */
  .agenda-list { display: flex; flex-direction: column; gap: .75rem; }
  .agenda-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }
  .agenda-item-header {
    display: flex; align-items: center; gap: .75rem;
    padding: 1rem 1.25rem;
    cursor: pointer;
  }
  .agenda-num {
    width: 28px; height: 28px;
    background: var(--surface2);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: .75rem;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  .agenda-item-title { flex: 1; font-weight: 500; font-size: .9rem; }
  .agenda-item-body {
    padding: 0 1.25rem 1.25rem;
    border-top: 1px solid var(--border);
    display: none;
  }
  .agenda-item.expanded .agenda-item-body { display: block; }
  .agenda-item.expanded { border-color: var(--accent2); }
  .field-label { font-size: .72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; font-weight: 500; margin-bottom: .3rem; margin-top: .9rem; }

  /* â”€â”€ ACTIONS TABLE â”€â”€ */
  .actions-list { display: flex; flex-direction: column; gap: .5rem; }
  .action-row {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: .75rem 1rem;
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    gap: .75rem;
    transition: border-color .15s;
  }
  .action-row:hover { border-color: var(--border); }
  .action-title { font-size: .88rem; font-weight: 500; }
  .action-meta { font-size: .75rem; color: var(--text-muted); margin-top: .15rem; }
  .progress-bar-wrap { height: 4px; background: var(--surface2); border-radius: 2px; margin-top: .4rem; overflow: hidden; }
  .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 2px; transition: width .3s; }

  /* â”€â”€ FILTERS â”€â”€ */
  .filters {
    display: flex; gap: .5rem; flex-wrap: wrap;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .filter-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: .35rem .7rem;
    color: var(--text);
    font-size: .8rem;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    cursor: pointer;
  }
  .filter-select:focus { border-color: var(--accent); }
  .search-input {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: .35rem .7rem;
    color: var(--text);
    font-size: .8rem;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    min-width: 200px;
  }
  .search-input:focus { border-color: var(--accent); }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.75rem;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalIn .2s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: scale(.96) translateY(8px); } }
  .modal h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 1.25rem; }
  .modal-actions { display: flex; gap: .5rem; justify-content: flex-end; margin-top: 1.5rem; }
  .form-row { display: flex; flex-direction: column; gap: .4rem; margin-bottom: .9rem; }
  .form-row label { font-size: .75rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: .04em; }
  .form-row input, .form-row select, .form-row textarea {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: .65rem .9rem;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: .85rem;
    outline: none;
    transition: border-color .15s;
    width: 100%;
  }
  .form-row input:focus, .form-row select:focus, .form-row textarea:focus { border-color: var(--accent); }
  .form-row textarea { min-height: 80px; resize: vertical; }
  .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }

  /* â”€â”€ STATS CARDS â”€â”€ */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: .75rem;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: .75rem 1rem;
    text-align: center;
  }
  .stat-value { font-family: 'DM Mono', monospace; font-size: 1.5rem; font-weight: 500; color: var(--accent); }
  .stat-label { font-size: .72rem; color: var(--text-muted); margin-top: .15rem; text-transform: uppercase; letter-spacing: .05em; }

  /* â”€â”€ TIMELINE â”€â”€ */
  .timeline { display: flex; flex-direction: column; gap: 0; padding: 1.5rem; }
  .timeline-item { display: flex; gap: 1rem; }
  .timeline-line { display: flex; flex-direction: column; align-items: center; width: 20px; }
  .timeline-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); flex-shrink: 0; margin-top: 5px; }
  .timeline-connector { flex: 1; width: 2px; background: var(--border); }
  .timeline-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: .9rem 1.1rem;
    flex: 1;
    margin-bottom: .75rem;
    cursor: pointer;
    transition: border-color .15s;
  }
  .timeline-card:hover { border-color: var(--accent); }
  .timeline-card h4 { font-size: .9rem; font-weight: 600; }
  .timeline-card .tc-meta { font-size: .75rem; color: var(--text-muted); margin-top: .2rem; font-family: 'DM Mono', monospace; }
  .timeline-card .tc-footer { display: flex; gap: .4rem; flex-wrap: wrap; margin-top: .6rem; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed; bottom: 1.5rem; right: 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: .7rem 1.1rem;
    font-size: .82rem;
    z-index: 9999;
    display: none;
    align-items: center;
    gap: .5rem;
    box-shadow: 0 8px 32px rgba(0,0,0,.5);
    animation: slideIn .2s ease;
    max-width: 300px;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } }
  #toast.success { border-color: var(--accent); color: var(--accent); }
  #toast.error { border-color: var(--accent3); color: var(--accent3); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 1rem; padding: 4rem 2rem; text-align: center;
  }
  .empty-icon { font-size: 3rem; opacity: .3; }
  .empty-state h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; color: var(--text-muted); }
  .empty-state p { font-size: .85rem; color: var(--text-dim); }

  /* â”€â”€ SCROLLBAR â”€â”€ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }

  /* â”€â”€ RESPONSIVE â”€â”€ */
  @media (max-width: 640px) {
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    nav { display: none; }
    .meetings-grid { grid-template-columns: 1fr; }
    .form-grid-2 { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- SETUP SCREEN (affichÃ© seulement si ouvert hors de Grist) -->
<div id="setup-screen">
  <div>
    <div class="logo" style="justify-content:center;margin-bottom:.5rem">
      <span class="logo-dot"></span>
      <span>MeetingOS</span>
    </div>
    <h1>Suivi de<br>RÃ©unions</h1>
  </div>
  <p>Ce widget doit Ãªtre installÃ© comme <strong>Custom Widget</strong> dans un document Grist.<br>Il se connecte automatiquement sans configuration.</p>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;max-width:480px;text-align:left">
    <div style="font-size:.8rem;color:var(--text-muted);line-height:1.8">
      <div style="color:var(--accent);font-weight:600;margin-bottom:.5rem">ğŸ“‹ Installation</div>
      1. Dans Grist â†’ <strong>Add Widget â†’ Custom</strong><br>
      2. Entrer l'URL de ce fichier<br>
      3. AccÃ¨s requis : <strong>Full document access</strong><br>
      4. Les tables sont crÃ©Ã©es automatiquement âœ“
    </div>
  </div>
</div>

<!-- LOADER -->
<div id="loader">
  <div class="spinner"></div>
  <p id="loader-msg">Initialisation de la structure Gristâ€¦</p>
</div>

<!-- MAIN APP -->
<div id="app">
  <header>
    <div class="logo">
      <span class="logo-dot"></span>
      MeetingOS
    </div>
    <nav>
      <button class="tab active" onclick="switchTab('meetings', this)">RÃ©unions</button>
      <button class="tab" onclick="switchTab('actions', this)">Actions</button>
      <button class="tab" onclick="switchTab('timeline', this)">Historique</button>
    </nav>
    <div class="header-actions">
      <button class="btn btn-secondary btn-sm" onclick="refreshAll()">â†» Sync</button>
      <button class="btn btn-primary btn-sm" onclick="openNewMeetingModal()">+ RÃ©union</button>
    </div>
  </header>

  <!-- PANEL: MEETINGS -->
  <div id="panel-meetings" class="panel active">
    <div class="page-header">
      <div>
        <h2>RÃ©unions</h2>
        <p>Planifiez, animez et archivez vos sÃ©ances</p>
      </div>
      <button class="btn btn-primary" onclick="openNewMeetingModal()">+ Nouvelle rÃ©union</button>
    </div>
    <div class="filters">
      <input class="search-input" type="text" placeholder="ğŸ” Rechercherâ€¦" oninput="filterMeetings(this.value)" id="meetings-search" />
      <select class="filter-select" onchange="filterMeetings()" id="filter-status">
        <option value="">Tous les statuts</option>
        <option value="PlanifiÃ©e">PlanifiÃ©e</option>
        <option value="En cours">En cours</option>
        <option value="TerminÃ©e">TerminÃ©e</option>
        <option value="AnnulÃ©e">AnnulÃ©e</option>
      </select>
    </div>
    <div id="meetings-grid" class="meetings-grid"></div>
  </div>

  <!-- PANEL: ACTIONS GLOBALES -->
  <div id="panel-actions" class="panel">
    <div class="page-header">
      <div>
        <h2>Actions</h2>
        <p>Suivi global de tous les points Ã  traiter</p>
      </div>
      <button class="btn btn-primary" onclick="openNewActionModal(null)">+ Nouvelle action</button>
    </div>
    <div class="stats-bar" id="actions-stats"></div>
    <div class="filters">
      <input class="search-input" type="text" placeholder="ğŸ” Rechercher une actionâ€¦" oninput="filterActions()" id="actions-search" />
      <select class="filter-select" onchange="filterActions()" id="filter-action-status">
        <option value="">Tous les statuts</option>
        <option value="Ã€ faire">Ã€ faire</option>
        <option value="En cours">En cours</option>
        <option value="BloquÃ©">BloquÃ©</option>
        <option value="TerminÃ©">TerminÃ©</option>
        <option value="AnnulÃ©">AnnulÃ©</option>
      </select>
      <select class="filter-select" onchange="filterActions()" id="filter-action-assignee">
        <option value="">Tous les responsables</option>
      </select>
      <select class="filter-select" onchange="filterActions()" id="filter-action-priority">
        <option value="">Toutes prioritÃ©s</option>
        <option value="Haute">Haute</option>
        <option value="Moyenne">Moyenne</option>
        <option value="Basse">Basse</option>
      </select>
    </div>
    <div id="actions-list" class="actions-list" style="padding:1rem 1.5rem"></div>
  </div>

  <!-- PANEL: HISTORIQUE -->
  <div id="panel-timeline" class="panel">
    <div class="page-header">
      <div>
        <h2>Historique</h2>
        <p>Chronologie de toutes les rÃ©unions</p>
      </div>
    </div>
    <div id="timeline-content" class="timeline"></div>
  </div>
</div>

<!-- DETAIL VIEW (rÃ©union sÃ©lectionnÃ©e) -->
<div id="detail-view">
  <div class="detail-header">
    <button class="btn-icon" onclick="closeDetail()" title="Retour">â†</button>
    <h2 id="detail-title">RÃ©union</h2>
    <div style="display:flex;gap:.5rem">
      <button class="btn btn-secondary btn-sm" onclick="editCurrentMeeting()">âœ Modifier</button>
      <button class="btn btn-primary btn-sm" onclick="openNewAgendaModal()">+ Point ODJ</button>
      <button class="btn btn-secondary btn-sm" onclick="openNewActionModal(null)">+ Action</button>
    </div>
  </div>
  <div class="detail-meta" id="detail-meta"></div>
  <div class="detail-tabs">
    <button class="detail-tab active" onclick="switchDetailTab('odj', this)">ğŸ“‹ Ordre du jour</button>
    <button class="detail-tab" onclick="switchDetailTab('cr', this)">ğŸ“ Compte rendu</button>
    <button class="detail-tab" onclick="switchDetailTab('actions-detail', this)">âš¡ Actions</button>
    <button class="detail-tab" onclick="switchDetailTab('participants', this)">ğŸ‘¥ Participants</button>
  </div>
  <div class="detail-content">
    <div id="tab-odj"></div>
    <div id="tab-cr" style="display:none"></div>
    <div id="tab-actions-detail" style="display:none"></div>
    <div id="tab-participants" style="display:none"></div>
  </div>
</div>

<!-- MODALS -->
<div id="modal-meeting" class="modal-overlay">
  <div class="modal">
    <h3 id="modal-meeting-title">Nouvelle rÃ©union</h3>
    <div class="form-row"><label>Titre *</label><input id="f-title" type="text" placeholder="Ex: RÃ©union de suivi projet X" /></div>
    <div class="form-grid-2">
      <div class="form-row"><label>Date *</label><input id="f-date" type="date" /></div>
      <div class="form-row"><label>Statut</label>
        <select id="f-status">
          <option>PlanifiÃ©e</option><option>En cours</option><option>TerminÃ©e</option><option>AnnulÃ©e</option>
        </select>
      </div>
    </div>
    <div class="form-grid-2">
      <div class="form-row"><label>Heure dÃ©but</label><input id="f-time-start" type="time" /></div>
      <div class="form-row"><label>Heure fin</label><input id="f-time-end" type="time" /></div>
    </div>
    <div class="form-row"><label>Lieu / Lien visio</label><input id="f-location" type="text" placeholder="Salle B2 ou https://meet.google.com/â€¦" /></div>
    <div class="form-grid-2">
      <div class="form-row"><label>Animateur</label><input id="f-facilitator" type="text" /></div>
      <div class="form-row"><label>RÃ©dacteur CR</label><input id="f-secretary" type="text" /></div>
    </div>
    <div class="form-row"><label>Notes / Contexte</label><textarea id="f-notes" placeholder="Contexte gÃ©nÃ©ral de la rÃ©unionâ€¦"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-meeting')">Annuler</button>
      <button class="btn btn-primary" onclick="saveMeeting()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="modal-agenda" class="modal-overlay">
  <div class="modal">
    <h3>Point d'ordre du jour</h3>
    <div class="form-grid-2">
      <div class="form-row"><label>NÂ° d'ordre</label><input id="fa-order" type="number" min="1" value="1" /></div>
      <div class="form-row"><label>Type</label>
        <select id="fa-type">
          <option>Information</option><option>Discussion</option><option>DÃ©cision</option><option>Revue actions</option>
        </select>
      </div>
    </div>
    <div class="form-row"><label>Titre du point *</label><input id="fa-title" type="text" placeholder="Ex: Bilan financier T3" /></div>
    <div class="form-grid-2">
      <div class="form-row"><label>Intervenant</label><input id="fa-presenter" type="text" /></div>
      <div class="form-row"><label>DurÃ©e prÃ©vue (min)</label><input id="fa-duration" type="number" min="5" step="5" value="15" /></div>
    </div>
    <div class="form-row"><label>Description / Contexte</label><textarea id="fa-description" placeholder="DÃ©tails sur ce pointâ€¦"></textarea></div>
    <div class="form-row"><label>RÃ©sumÃ© / CR du point</label><textarea id="fa-summary" placeholder="Remplir aprÃ¨s la rÃ©unionâ€¦"></textarea></div>
    <div class="form-row"><label>DÃ©cision prise</label><textarea id="fa-decision" placeholder="DÃ©cision ou conclusionâ€¦" style="min-height:60px"></textarea></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-agenda')">Annuler</button>
      <button class="btn btn-primary" onclick="saveAgendaItem()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="modal-action" class="modal-overlay">
  <div class="modal">
    <h3 id="modal-action-title">Nouvelle action</h3>
    <div class="form-row"><label>Description *</label><input id="fac-title" type="text" placeholder="Ex: RÃ©diger le cahier des charges" /></div>
    <div class="form-grid-2">
      <div class="form-row"><label>Responsable *</label><input id="fac-assignee" type="text" placeholder="PrÃ©nom Nom" /></div>
      <div class="form-row"><label>Ã‰chÃ©ance</label><input id="fac-due" type="date" /></div>
    </div>
    <div class="form-grid-2">
      <div class="form-row"><label>PrioritÃ©</label>
        <select id="fac-priority"><option>Haute</option><option selected>Moyenne</option><option>Basse</option></select>
      </div>
      <div class="form-row"><label>Statut</label>
        <select id="fac-status">
          <option>Ã€ faire</option><option>En cours</option><option>BloquÃ©</option><option>TerminÃ©</option><option>AnnulÃ©</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <label>Avancement (<span id="fac-pct-label">0</span>%)</label>
      <input id="fac-progress" type="range" min="0" max="100" value="0" oninput="document.getElementById('fac-pct-label').textContent=this.value" style="background:var(--bg);accent-color:var(--accent);width:100%" />
    </div>
    <div class="form-row"><label>Notes</label><textarea id="fac-notes" placeholder="Commentaires, blocagesâ€¦"></textarea></div>
    <div class="form-row">
      <label>Point ODJ liÃ©</label>
      <select id="fac-agenda-item"><option value="">â€” Aucun â€”</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-action')">Annuler</button>
      <button class="btn btn-primary" onclick="saveAction()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="modal-participant" class="modal-overlay">
  <div class="modal">
    <h3>Ajouter un participant</h3>
    <div class="form-grid-2">
      <div class="form-row"><label>Nom *</label><input id="fp-name" type="text" /></div>
      <div class="form-row"><label>Email</label><input id="fp-email" type="email" /></div>
    </div>
    <div class="form-grid-2">
      <div class="form-row"><label>RÃ´le</label>
        <select id="fp-role"><option>InvitÃ©</option><option>Intervenant</option><option>Organisateur</option><option>ExcusÃ©</option></select>
      </div>
      <div class="form-row"><label>PrÃ©sent ?</label>
        <select id="fp-present"><option value="1">Oui</option><option value="0">Non</option></select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-participant')">Annuler</button>
      <button class="btn btn-primary" onclick="saveParticipant()">Ajouter</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATE = {
  meetings: [], agendaItems: [], actionItems: [], participants: [],
  currentMeetingId: null,
  editMeetingId: null, editAgendaId: null, editActionId: null,
  currentDetailTab: 'odj',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRIST TABLES SCHEMA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABLES = {
  Meetings: [
    { id: 'title',              fields: { label: 'Titre', type: 'Text' } },
    { id: 'date',               fields: { label: 'Date', type: 'Date' } },
    { id: 'time_start',         fields: { label: 'Heure dÃ©but', type: 'Text' } },
    { id: 'time_end',           fields: { label: 'Heure fin', type: 'Text' } },
    { id: 'location',           fields: { label: 'Lieu', type: 'Text' } },
    { id: 'status',             fields: { label: 'Statut', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['PlanifiÃ©e','En cours','TerminÃ©e','AnnulÃ©e'] }) } },
    { id: 'facilitator',        fields: { label: 'Animateur', type: 'Text' } },
    { id: 'secretary',          fields: { label: 'RÃ©dacteur', type: 'Text' } },
    { id: 'minutes_validated',  fields: { label: 'CR validÃ©', type: 'Bool' } },
    { id: 'notes',              fields: { label: 'Notes', type: 'Text' } },
  ],
  Participants: [
    { id: 'meeting_id',         fields: { label: 'RÃ©union', type: 'Ref:Meetings' } },
    { id: 'name',               fields: { label: 'Nom', type: 'Text' } },
    { id: 'email',              fields: { label: 'Email', type: 'Text' } },
    { id: 'role',               fields: { label: 'RÃ´le', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['InvitÃ©','Intervenant','Organisateur','ExcusÃ©'] }) } },
    { id: 'present',            fields: { label: 'PrÃ©sent', type: 'Bool' } },
  ],
  AgendaItems: [
    { id: 'meeting_id',         fields: { label: 'RÃ©union', type: 'Ref:Meetings' } },
    { id: 'order_num',          fields: { label: 'NÂ° ordre', type: 'Int' } },
    { id: 'title',              fields: { label: 'Titre', type: 'Text' } },
    { id: 'description',        fields: { label: 'Description', type: 'Text' } },
    { id: 'duration_min',       fields: { label: 'DurÃ©e (min)', type: 'Int' } },
    { id: 'presenter',          fields: { label: 'Intervenant', type: 'Text' } },
    { id: 'type',               fields: { label: 'Type', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['Information','Discussion','DÃ©cision','Revue actions'] }) } },
    { id: 'summary',            fields: { label: 'RÃ©sumÃ© CR', type: 'Text' } },
    { id: 'decision',           fields: { label: 'DÃ©cision', type: 'Text' } },
  ],
  ActionItems: [
    { id: 'agenda_item_id',     fields: { label: 'Point ODJ', type: 'Ref:AgendaItems' } },
    { id: 'meeting_id',         fields: { label: 'RÃ©union', type: 'Ref:Meetings' } },
    { id: 'title',              fields: { label: 'Description', type: 'Text' } },
    { id: 'assignee',           fields: { label: 'Responsable', type: 'Text' } },
    { id: 'due_date',           fields: { label: 'Ã‰chÃ©ance', type: 'Date' } },
    { id: 'priority',           fields: { label: 'PrioritÃ©', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['Haute','Moyenne','Basse'] }) } },
    { id: 'status',             fields: { label: 'Statut', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['Ã€ faire','En cours','BloquÃ©','TerminÃ©','AnnulÃ©'] }) } },
    { id: 'progress_pct',       fields: { label: 'Avancement %', type: 'Int' } },
    { id: 'notes',              fields: { label: 'Notes', type: 'Text' } },
    { id: 'reviewed_in_meeting_id', fields: { label: 'Revue dans rÃ©union', type: 'Ref:Meetings' } },
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRIST NATIVE API (via grist.docApi dans le widget)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Toutes les opÃ©rations passent par grist.docApi â€” pas de fetch/clÃ© API nÃ©cessaire

async function getTablesList() {
  const tables = await grist.docApi.listTables();
  return tables;
}

async function createTable(name, cols) {
  // AddTable : (table_id, columns) oÃ¹ columns = [{id, label, type, isFormula, formula}]
  const columns = cols.map(c => ({
    id: c.id,
    label: c.fields.label,
    type: c.fields.type === 'Ref:Meetings'    ? 'Ref:Meetings'
        : c.fields.type === 'Ref:AgendaItems' ? 'Ref:AgendaItems'
        : c.fields.type,
    isFormula: false,
    formula: '',
  }));
  await grist.docApi.applyUserActions([
    ['AddTable', name, columns]
  ]);
}

async function getRecords(table) {
  try {
    const data = await grist.docApi.fetchTable(table);
    // fetchTable retourne { id: [...], col1: [...], col2: [...] }
    const ids = data.id;
    const cols = Object.keys(data).filter(k => k !== 'id' && k !== 'manualSort');
    return ids.map((id, i) => {
      const rec = { id };
      cols.forEach(c => { rec[c] = data[c][i]; });
      return rec;
    });
  } catch(e) {
    console.warn('fetchTable error for', table, e);
    return [];
  }
}

async function addRecord(table, fields) {
  // Filtrer les valeurs nulles/undefined
  const colValues = {};
  Object.entries(fields).forEach(([k, v]) => { if (v !== undefined && v !== null) colValues[k] = v; });
  // BulkAddRecord : (table, row_ids, col_values) â€” row_ids=[0] = auto-assign
  const colKeys = Object.keys(colValues);
  const colData = {};
  colKeys.forEach(k => { colData[k] = [colValues[k]]; });
  const result = await grist.docApi.applyUserActions([
    ['BulkAddRecord', table, [null], colData]
  ]);
  return { id: result?.retValues?.[0]?.[0] };
}

async function updateRecord(table, id, fields) {
  const colValues = {};
  Object.entries(fields).forEach(([k, v]) => { if (v !== undefined) colValues[k] = v; });
  await grist.docApi.applyUserActions([
    ['BulkUpdateRecord', table, [id], Object.fromEntries(Object.entries(colValues).map(([k,v]) => [k,[v]]))]
  ]);
}

async function deleteRecord(table, id) {
  await grist.docApi.applyUserActions([
    ['BulkRemoveRecord', table, [id]]
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT GRIST WIDGET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initWidget() {
  if (typeof grist === 'undefined') {
    // Hors contexte Grist : afficher l'Ã©cran d'info
    document.getElementById('setup-screen').style.display = 'flex';
    return;
  }

  grist.ready({
    requiredAccess: 'full',
    columns: [],        // Ce widget n'a pas besoin de mapping de colonnes
    allowSelectBy: false,
  });

  // DÃ©marrer dÃ¨s que le plugin est prÃªt
  grist.onReady(async () => {
    hide('setup-screen');
    show('loader');
    try {
      await ensureTables();
      await loadAll();
      hide('loader');
      show('app');
      renderMeetings();
      showToast('âœ“ ConnectÃ© Ã  Grist', 'success');
    } catch(e) {
      console.error('Init error', e);
      setLoaderMsg('Erreur : ' + e.message);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP & ENSURE TABLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function ensureTables() {
  setLoaderMsg('VÃ©rification de la structure Gristâ€¦');
  let existing = [];
  try { existing = await getTablesList(); } catch(e) { existing = []; }

  for (const [name, cols] of Object.entries(TABLES)) {
    if (!existing.includes(name)) {
      setLoaderMsg(`CrÃ©ation de la table "${name}"â€¦`);
      try { await createTable(name, cols); } catch(e) { console.warn('Table create warn:', name, e); }
    }
  }
  setLoaderMsg('Structure vÃ©rifiÃ©e âœ“');
}

async function loadAll() {
  setLoaderMsg('Chargement des donnÃ©esâ€¦');
  const [m, a, ai, p] = await Promise.all([
    getRecords('Meetings'), getRecords('AgendaItems'),
    getRecords('ActionItems'), getRecords('Participants'),
  ]);
  STATE.meetings     = m;
  STATE.agendaItems  = a;
  STATE.actionItems  = ai;
  STATE.participants = p;
}

async function refreshAll() {
  showToast('Synchronisationâ€¦');
  await loadAll();
  renderMeetings();
  if (STATE.currentMeetingId) renderDetail(STATE.currentMeetingId);
  renderActionsPanel();
  renderTimeline();
  showToast('âœ“ DonnÃ©es mises Ã  jour', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) { const el = document.getElementById(id); if(el) { el.style.display='flex'; } }
function hide(id) { const el = document.getElementById(id); if(el) { el.style.display='none'; } }
function setLoaderMsg(msg) { document.getElementById('loader-msg').textContent = msg; }

function statusBadge(s) {
  const map = { 'PlanifiÃ©e': 'planned', 'En cours': 'active', 'TerminÃ©e': 'done', 'AnnulÃ©e': 'cancelled' };
  return `<span class="badge badge-${map[s]||'planned'}">${s}</span>`;
}
function actionStatusBadge(s) {
  const map = { 'Ã€ faire':'todo','En cours':'wip','BloquÃ©':'blocked','TerminÃ©':'done-action','AnnulÃ©':'cancelled' };
  return `<span class="badge badge-${map[s]||'todo'}">${s}</span>`;
}
function priorityBadge(p) {
  const map = { 'Haute':'high','Moyenne':'medium','Basse':'low' };
  return `<span class="badge badge-${map[p]||'medium'}">${p}</span>`;
}
function fmtDate(d) {
  if (!d) return 'â€”';
  // Grist stores dates as Unix seconds
  if (typeof d === 'number') d = new Date(d * 1000);
  else d = new Date(d);
  return d.toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' });
}
function fmtDateInput(d) {
  if (!d) return '';
  if (typeof d === 'number') d = new Date(d * 1000);
  else d = new Date(d);
  return d.toISOString().split('T')[0];
}
function dateToGrist(str) {
  if (!str) return null;
  return Math.floor(new Date(str).getTime() / 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEETINGS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMeetings() {
  const search = (document.getElementById('meetings-search')?.value || '').toLowerCase();
  const statusF = document.getElementById('filter-status')?.value || '';
  let meetings = STATE.meetings.filter(m => {
    if (statusF && m.status !== statusF) return false;
    if (search && !m.title?.toLowerCase().includes(search)) return false;
    return true;
  });
  meetings.sort((a, b) => (b.date || 0) - (a.date || 0));
  const grid = document.getElementById('meetings-grid');
  if (!meetings.length) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <div class="empty-icon">ğŸ“…</div>
      <h3>Aucune rÃ©union</h3>
      <p>CrÃ©ez votre premiÃ¨re rÃ©union pour commencer</p>
    </div>`;
    return;
  }
  grid.innerHTML = meetings.map(m => {
    const actions = STATE.actionItems.filter(a => a.meeting_id === m.id);
    const openActions = actions.filter(a => !['TerminÃ©','AnnulÃ©'].includes(a.status));
    const agendaCount = STATE.agendaItems.filter(a => a.meeting_id === m.id).length;
    return `<div class="meeting-card" onclick="openDetail(${m.id})">
      <div class="meeting-card-header">
        <div>
          <h3>${m.title || 'Sans titre'}</h3>
          <div class="meeting-date">ğŸ“… ${fmtDate(m.date)}${m.time_start ? ' Â· ' + m.time_start : ''}</div>
        </div>
        ${statusBadge(m.status || 'PlanifiÃ©e')}
      </div>
      ${m.location ? `<div style="font-size:.78rem;color:var(--text-muted);margin-bottom:.5rem">ğŸ“ ${m.location}</div>` : ''}
      ${m.facilitator ? `<div style="font-size:.78rem;color:var(--text-muted);margin-bottom:.5rem">ğŸ‘¤ ${m.facilitator}</div>` : ''}
      <div class="meeting-card-footer">
        <span class="badge" style="background:var(--surface2);color:var(--text-muted)">ğŸ“‹ ${agendaCount} point${agendaCount!==1?'s':''}</span>
        ${openActions.length ? `<span class="badge badge-todo">âš¡ ${openActions.length} action${openActions.length!==1?'s':''}</span>` : ''}
        ${m.minutes_validated ? `<span class="badge badge-done">âœ“ CR validÃ©</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

function filterMeetings() { renderMeetings(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id) {
  STATE.currentMeetingId = id;
  const m = STATE.meetings.find(x => x.id === id);
  if (!m) return;
  hide('app');
  const dv = document.getElementById('detail-view');
  dv.style.display = 'flex';
  dv.style.flexDirection = 'column';
  document.getElementById('detail-title').textContent = m.title || 'RÃ©union';
  document.getElementById('detail-meta').innerHTML = `
    <span>ğŸ“… <strong>${fmtDate(m.date)}</strong></span>
    ${m.time_start ? `<span>â° <strong>${m.time_start}${m.time_end?' â†’ '+m.time_end:''}</strong></span>` : ''}
    ${m.location ? `<span>ğŸ“ <strong>${m.location}</strong></span>` : ''}
    ${m.facilitator ? `<span>ğŸ‘¤ Animateur: <strong>${m.facilitator}</strong></span>` : ''}
    ${m.secretary ? `<span>âœï¸ RÃ©dacteur: <strong>${m.secretary}</strong></span>` : ''}
    ${statusBadge(m.status || 'PlanifiÃ©e')}
    ${m.minutes_validated ? `<span class="badge badge-done">âœ“ CR validÃ©</span>` : ''}
  `;
  switchDetailTab('odj', document.querySelector('.detail-tab'));
  renderDetailODJ();
}

function closeDetail() {
  document.getElementById('detail-view').style.display = 'none';
  show('app');
}

function switchDetailTab(tab, el) {
  STATE.currentDetailTab = tab;
  document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  else {
    const tabs = document.querySelectorAll('.detail-tab');
    const map = { 'odj': 0, 'cr': 1, 'actions-detail': 2, 'participants': 3 };
    if (tabs[map[tab]]) tabs[map[tab]].classList.add('active');
  }
  ['odj','cr','actions-detail','participants'].forEach(t => {
    document.getElementById('tab-' + t).style.display = t === tab ? 'block' : 'none';
  });
  if (tab === 'odj') renderDetailODJ();
  if (tab === 'cr') renderDetailCR();
  if (tab === 'actions-detail') renderDetailActions();
  if (tab === 'participants') renderDetailParticipants();
}

function renderDetailODJ() {
  const id = STATE.currentMeetingId;
  const items = STATE.agendaItems.filter(a => a.meeting_id === id).sort((a,b) => (a.order_num||0)-(b.order_num||0));
  const el = document.getElementById('tab-odj');
  if (!items.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><h3>Aucun point Ã  l'ordre du jour</h3><p>Ajoutez des points avec le bouton "+ Point ODJ"</p></div>`;
    return;
  }
  el.innerHTML = `<div class="agenda-list">${items.map(item => `
    <div class="agenda-item" id="agenda-${item.id}">
      <div class="agenda-item-header" onclick="toggleAgenda(${item.id})">
        <div class="agenda-num">${item.order_num || '?'}</div>
        <div class="agenda-item-title">${item.title || 'Point sans titre'}</div>
        <span class="badge" style="background:var(--surface2);color:var(--text-muted);font-size:.7rem">${item.type||'Discussion'}</span>
        ${item.duration_min ? `<span style="font-size:.75rem;color:var(--text-muted);font-family:'DM Mono',monospace">${item.duration_min}min</span>` : ''}
        <button class="btn-icon" onclick="event.stopPropagation();editAgendaItem(${item.id})" title="Modifier">âœ</button>
        <button class="btn-icon" style="color:var(--accent3)" onclick="event.stopPropagation();deleteAgendaItem(${item.id})" title="Supprimer">âœ•</button>
        <span style="color:var(--text-dim);font-size:.8rem">â–¾</span>
      </div>
      <div class="agenda-item-body">
        ${item.presenter ? `<div class="field-label">Intervenant</div><div style="font-size:.85rem">${item.presenter}</div>` : ''}
        ${item.description ? `<div class="field-label">Description</div><div style="font-size:.85rem;color:var(--text-muted);white-space:pre-wrap">${item.description}</div>` : ''}
        <div class="field-label">RÃ©sumÃ© / CR</div>
        <textarea style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.6rem;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.83rem;resize:vertical;min-height:80px;outline:none" 
          placeholder="RÃ©sumÃ© du point aprÃ¨s la rÃ©unionâ€¦" 
          onblur="saveAgendaSummary(${item.id}, this.value)">${item.summary || ''}</textarea>
        <div class="field-label">DÃ©cision</div>
        <textarea style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.6rem;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.83rem;resize:vertical;min-height:60px;outline:none" 
          placeholder="DÃ©cision priseâ€¦" 
          onblur="saveAgendaDecision(${item.id}, this.value)">${item.decision || ''}</textarea>
        <div style="display:flex;gap:.5rem;margin-top:.75rem">
          <button class="btn btn-secondary btn-sm" onclick="openNewActionModal(${item.id})">+ Action liÃ©e</button>
        </div>
        ${renderMiniActions(item.id)}
      </div>
    </div>`).join('')}</div>`;
}

function renderMiniActions(agendaItemId) {
  const actions = STATE.actionItems.filter(a => a.agenda_item_id === agendaItemId);
  if (!actions.length) return '';
  return `<div style="margin-top:.75rem">
    <div class="field-label">Actions liÃ©es</div>
    <div style="display:flex;flex-direction:column;gap:.4rem">
    ${actions.map(a => `<div style="background:var(--surface2);border-radius:6px;padding:.5rem .75rem;font-size:.8rem;display:flex;align-items:center;gap:.5rem">
      <span style="flex:1">${a.title}</span>
      <span style="color:var(--text-muted)">${a.assignee}</span>
      ${actionStatusBadge(a.status||'Ã€ faire')}
    </div>`).join('')}
    </div>
  </div>`;
}

function renderDetailCR() {
  const id = STATE.currentMeetingId;
  const m = STATE.meetings.find(x => x.id === id);
  const items = STATE.agendaItems.filter(a => a.meeting_id === id).sort((a,b)=>(a.order_num||0)-(b.order_num||0));
  const el = document.getElementById('tab-cr');
  el.innerHTML = `
    <div style="max-width:720px">
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem">
        <h3 style="font-family:'DM Serif Display',serif;font-size:1.1rem;flex:1">Compte rendu</h3>
        <label style="display:flex;align-items:center;gap:.5rem;font-size:.82rem;color:var(--text-muted);cursor:pointer">
          <input type="checkbox" ${m?.minutes_validated?'checked':''} onchange="toggleCRValidated(this.checked)" style="accent-color:var(--accent)"> CR validÃ©
        </label>
      </div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem">
        <div style="font-family:'DM Serif Display',serif;font-size:1.4rem;margin-bottom:1rem">${m?.title||'RÃ©union'}</div>
        <div style="font-size:.8rem;color:var(--text-muted);margin-bottom:1.5rem;font-family:'DM Mono',monospace">
          ${fmtDate(m?.date)} ${m?.time_start||''} ${m?.time_end?'â†’ '+m.time_end:''} ${m?.location?'Â· '+m.location:''}
        </div>
        ${m?.notes ? `<div style="margin-bottom:1.5rem;font-size:.85rem;color:var(--text-muted);padding:.75rem;background:var(--surface2);border-radius:6px">${m.notes}</div>` : ''}
        ${items.length ? items.map((item,i) => `
          <div style="margin-bottom:1.25rem;padding-bottom:1.25rem;border-bottom:1px solid var(--border)">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <span style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-muted)">${item.order_num||i+1}.</span>
              <strong style="font-size:.9rem">${item.title}</strong>
              <span class="badge" style="background:var(--surface2);color:var(--text-muted);font-size:.68rem">${item.type||'Discussion'}</span>
            </div>
            ${item.summary ? `<p style="font-size:.83rem;color:var(--text-muted);margin-bottom:.4rem;white-space:pre-wrap">${item.summary}</p>` : '<p style="font-size:.8rem;color:var(--text-dim);font-style:italic">Aucun rÃ©sumÃ©.</p>'}
            ${item.decision ? `<div style="background:rgba(200,240,74,.07);border-left:3px solid var(--accent);padding:.5rem .75rem;border-radius:0 6px 6px 0;font-size:.82rem;margin-top:.4rem"><strong style="color:var(--accent)">DÃ©cision :</strong> ${item.decision}</div>` : ''}
          </div>`).join('') : '<p style="color:var(--text-dim);font-size:.85rem">Aucun point Ã  l\'ordre du jour.</p>'}
        ${renderCRActions(id)}
      </div>
    </div>`;
}

function renderCRActions(meetingId) {
  const actions = STATE.actionItems.filter(a => a.meeting_id === meetingId && !['TerminÃ©','AnnulÃ©'].includes(a.status));
  if (!actions.length) return '';
  return `<div style="margin-top:1rem">
    <div style="font-weight:600;font-size:.85rem;margin-bottom:.6rem">âš¡ Actions issues de cette rÃ©union</div>
    <table style="width:100%;border-collapse:collapse;font-size:.8rem">
      <thead><tr style="color:var(--text-muted);border-bottom:1px solid var(--border)">
        <th style="text-align:left;padding:.3rem">Action</th><th style="text-align:left;padding:.3rem">Responsable</th><th style="text-align:left;padding:.3rem">Ã‰chÃ©ance</th><th style="text-align:left;padding:.3rem">Statut</th>
      </tr></thead>
      <tbody>${actions.map(a => `<tr style="border-bottom:1px solid var(--surface2)">
        <td style="padding:.4rem">${a.title}</td>
        <td style="padding:.4rem;color:var(--text-muted)">${a.assignee}</td>
        <td style="padding:.4rem;font-family:'DM Mono',monospace;font-size:.75rem">${fmtDate(a.due_date)}</td>
        <td style="padding:.4rem">${actionStatusBadge(a.status||'Ã€ faire')}</td>
      </tr>`).join('')}</tbody>
    </table>
  </div>`;
}

function renderDetailActions() {
  const id = STATE.currentMeetingId;
  const actions = STATE.actionItems.filter(a => a.meeting_id === id);
  const el = document.getElementById('tab-actions-detail');
  if (!actions.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš¡</div><h3>Aucune action</h3><p>CrÃ©ez des actions depuis les points ODJ ou le bouton "+ Action"</p></div>`;
    return;
  }
  el.innerHTML = `<div class="actions-list">${actions.map(a => renderActionRow(a)).join('')}</div>`;
}

function renderDetailParticipants() {
  const id = STATE.currentMeetingId;
  const parts = STATE.participants.filter(p => p.meeting_id === id);
  const el = document.getElementById('tab-participants');
  el.innerHTML = `
    <div style="display:flex;justify-content:flex-end;margin-bottom:1rem">
      <button class="btn btn-primary btn-sm" onclick="openParticipantModal()">+ Ajouter participant</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:.5rem">
    ${!parts.length ? `<div class="empty-state"><div class="empty-icon">ğŸ‘¥</div><h3>Aucun participant</h3></div>` :
      parts.map(p => `<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:.75rem 1rem;display:flex;align-items:center;gap:.75rem">
        <div style="width:36px;height:36px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0">${(p.name||'?')[0].toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-size:.88rem;font-weight:500">${p.name}</div>
          ${p.email ? `<div style="font-size:.75rem;color:var(--text-muted)">${p.email}</div>` : ''}
        </div>
        <span class="badge" style="background:var(--surface2);color:var(--text-muted)">${p.role||'InvitÃ©'}</span>
        <span class="badge ${p.present?'badge-done':'badge-cancelled'}">${p.present?'âœ“ PrÃ©sent':'Absent'}</span>
        <button class="btn-icon" style="color:var(--accent3)" onclick="deleteParticipant(${p.id})">âœ•</button>
      </div>`).join('')}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActionsPanel() {
  const actions = STATE.actionItems;
  const todo = actions.filter(a => a.status === 'Ã€ faire').length;
  const wip  = actions.filter(a => a.status === 'En cours').length;
  const done = actions.filter(a => a.status === 'TerminÃ©').length;
  const bloc = actions.filter(a => a.status === 'BloquÃ©').length;
  document.getElementById('actions-stats').innerHTML = `
    <div class="stat-card"><div class="stat-value" style="color:var(--status-todo)">${todo}</div><div class="stat-label">Ã€ faire</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--status-wip)">${wip}</div><div class="stat-label">En cours</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--accent3)">${bloc}</div><div class="stat-label">BloquÃ©</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--status-done)">${done}</div><div class="stat-label">TerminÃ©</div></div>`;
  // Build assignees list
  const assignees = [...new Set(actions.map(a => a.assignee).filter(Boolean))].sort();
  const sel = document.getElementById('filter-action-assignee');
  const cur = sel.value;
  sel.innerHTML = `<option value="">Tous les responsables</option>` + assignees.map(a => `<option ${a===cur?'selected':''}>${a}</option>`).join('');
  filterActions();
}

function filterActions() {
  const search   = document.getElementById('actions-search')?.value.toLowerCase() || '';
  const statusF  = document.getElementById('filter-action-status')?.value || '';
  const assigneeF= document.getElementById('filter-action-assignee')?.value || '';
  const priorityF= document.getElementById('filter-action-priority')?.value || '';
  let actions = STATE.actionItems.filter(a => {
    if (statusF && a.status !== statusF) return false;
    if (assigneeF && a.assignee !== assigneeF) return false;
    if (priorityF && a.priority !== priorityF) return false;
    if (search && !a.title?.toLowerCase().includes(search) && !a.assignee?.toLowerCase().includes(search)) return false;
    return true;
  });
  actions.sort((a, b) => {
    const prio = { 'Haute': 0, 'Moyenne': 1, 'Basse': 2 };
    return (prio[a.priority]||1) - (prio[b.priority]||1);
  });
  const el = document.getElementById('actions-list');
  if (!actions.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">âš¡</div><h3>Aucune action</h3><p>CrÃ©ez des actions depuis vos rÃ©unions</p></div>`;
    return;
  }
  el.innerHTML = `<div class="actions-list">${actions.map(a => renderActionRow(a)).join('')}</div>`;
}

function renderActionRow(a) {
  const meeting = STATE.meetings.find(m => m.id === a.meeting_id);
  const isLate = a.due_date && new Date(a.due_date*1000) < new Date() && !['TerminÃ©','AnnulÃ©'].includes(a.status);
  return `<div class="action-row" id="action-row-${a.id}">
    <div>
      <div class="action-title">${a.title||'Sans titre'}</div>
      <div class="action-meta">
        ğŸ‘¤ ${a.assignee||'â€”'} 
        ${a.due_date ? ` Â· ğŸ“… <span style="color:${isLate?'var(--accent3)':'var(--text-muted)'}">${fmtDate(a.due_date)}</span>` : ''}
        ${meeting ? ` Â· ğŸ—‚ ${meeting.title}` : ''}
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar" style="width:${a.progress_pct||0}%"></div></div>
    </div>
    ${priorityBadge(a.priority||'Moyenne')}
    ${actionStatusBadge(a.status||'Ã€ faire')}
    <div style="display:flex;gap:.3rem">
      <button class="btn-icon" onclick="editAction(${a.id})" title="Modifier">âœ</button>
      <button class="btn-icon" style="color:var(--accent3)" onclick="deleteAction(${a.id})" title="Supprimer">âœ•</button>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimeline() {
  const meetings = [...STATE.meetings].sort((a, b) => (b.date||0) - (a.date||0));
  const el = document.getElementById('timeline-content');
  if (!meetings.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“…</div><h3>Aucune rÃ©union</h3></div>`;
    return;
  }
  el.innerHTML = meetings.map((m, i) => {
    const actions = STATE.actionItems.filter(a => a.meeting_id === m.id);
    const open = actions.filter(a => !['TerminÃ©','AnnulÃ©'].includes(a.status));
    const done = actions.filter(a => a.status === 'TerminÃ©');
    return `<div class="timeline-item">
      <div class="timeline-line">
        <div class="timeline-dot" style="background:${m.status==='TerminÃ©e'?'var(--accent2)':m.status==='En cours'?'var(--accent)':'var(--border)'}"></div>
        ${i < meetings.length-1 ? '<div class="timeline-connector"></div>' : ''}
      </div>
      <div class="timeline-card" onclick="openDetail(${m.id})">
        <h4>${m.title||'RÃ©union'}</h4>
        <div class="tc-meta">${fmtDate(m.date)}${m.facilitator?' Â· '+m.facilitator:''}</div>
        <div class="tc-footer">
          ${statusBadge(m.status||'PlanifiÃ©e')}
          ${open.length?`<span class="badge badge-todo">${open.length} action${open.length>1?'s':''} ouvertes</span>`:''}
          ${done.length?`<span class="badge badge-done">${done.length} terminÃ©es</span>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING (main)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab)?.classList.add('active');
  if (tab === 'actions') renderActionsPanel();
  if (tab === 'timeline') renderTimeline();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function openNewMeetingModal() {
  STATE.editMeetingId = null;
  document.getElementById('modal-meeting-title').textContent = 'Nouvelle rÃ©union';
  document.getElementById('f-title').value = '';
  document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('f-status').value = 'PlanifiÃ©e';
  document.getElementById('f-time-start').value = '';
  document.getElementById('f-time-end').value = '';
  document.getElementById('f-location').value = '';
  document.getElementById('f-facilitator').value = '';
  document.getElementById('f-secretary').value = '';
  document.getElementById('f-notes').value = '';
  openModal('modal-meeting');
}

function editCurrentMeeting() {
  const m = STATE.meetings.find(x => x.id === STATE.currentMeetingId);
  if (!m) return;
  STATE.editMeetingId = m.id;
  document.getElementById('modal-meeting-title').textContent = 'Modifier la rÃ©union';
  document.getElementById('f-title').value = m.title || '';
  document.getElementById('f-date').value = fmtDateInput(m.date);
  document.getElementById('f-status').value = m.status || 'PlanifiÃ©e';
  document.getElementById('f-time-start').value = m.time_start || '';
  document.getElementById('f-time-end').value = m.time_end || '';
  document.getElementById('f-location').value = m.location || '';
  document.getElementById('f-facilitator').value = m.facilitator || '';
  document.getElementById('f-secretary').value = m.secretary || '';
  document.getElementById('f-notes').value = m.notes || '';
  openModal('modal-meeting');
}

async function saveMeeting() {
  const fields = {
    title:       document.getElementById('f-title').value.trim(),
    date:        dateToGrist(document.getElementById('f-date').value),
    status:      document.getElementById('f-status').value,
    time_start:  document.getElementById('f-time-start').value,
    time_end:    document.getElementById('f-time-end').value,
    location:    document.getElementById('f-location').value,
    facilitator: document.getElementById('f-facilitator').value,
    secretary:   document.getElementById('f-secretary').value,
    notes:       document.getElementById('f-notes').value,
  };
  if (!fields.title) { showToast('Le titre est obligatoire', 'error'); return; }
  try {
    if (STATE.editMeetingId) {
      await updateRecord('Meetings', STATE.editMeetingId, fields);
      showToast('âœ“ RÃ©union modifiÃ©e', 'success');
    } else {
      await addRecord('Meetings', fields);
      showToast('âœ“ RÃ©union crÃ©Ã©e', 'success');
    }
    closeModal('modal-meeting');
    await loadAll();
    renderMeetings();
    if (STATE.currentMeetingId) { openDetail(STATE.currentMeetingId); }
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

function openNewAgendaModal() {
  STATE.editAgendaId = null;
  const count = STATE.agendaItems.filter(a => a.meeting_id === STATE.currentMeetingId).length;
  document.getElementById('fa-order').value = count + 1;
  document.getElementById('fa-type').value = 'Discussion';
  document.getElementById('fa-title').value = '';
  document.getElementById('fa-presenter').value = '';
  document.getElementById('fa-duration').value = '15';
  document.getElementById('fa-description').value = '';
  document.getElementById('fa-summary').value = '';
  document.getElementById('fa-decision').value = '';
  openModal('modal-agenda');
}

function editAgendaItem(id) {
  const item = STATE.agendaItems.find(a => a.id === id);
  if (!item) return;
  STATE.editAgendaId = id;
  document.getElementById('fa-order').value = item.order_num || 1;
  document.getElementById('fa-type').value = item.type || 'Discussion';
  document.getElementById('fa-title').value = item.title || '';
  document.getElementById('fa-presenter').value = item.presenter || '';
  document.getElementById('fa-duration').value = item.duration_min || 15;
  document.getElementById('fa-description').value = item.description || '';
  document.getElementById('fa-summary').value = item.summary || '';
  document.getElementById('fa-decision').value = item.decision || '';
  openModal('modal-agenda');
}

async function saveAgendaItem() {
  const fields = {
    meeting_id:   STATE.currentMeetingId,
    order_num:    parseInt(document.getElementById('fa-order').value),
    type:         document.getElementById('fa-type').value,
    title:        document.getElementById('fa-title').value.trim(),
    presenter:    document.getElementById('fa-presenter').value,
    duration_min: parseInt(document.getElementById('fa-duration').value),
    description:  document.getElementById('fa-description').value,
    summary:      document.getElementById('fa-summary').value,
    decision:     document.getElementById('fa-decision').value,
  };
  if (!fields.title) { showToast('Le titre est obligatoire', 'error'); return; }
  try {
    if (STATE.editAgendaId) {
      await updateRecord('AgendaItems', STATE.editAgendaId, fields);
      showToast('âœ“ Point modifiÃ©', 'success');
    } else {
      await addRecord('AgendaItems', fields);
      showToast('âœ“ Point ajoutÃ©', 'success');
    }
    closeModal('modal-agenda');
    await loadAll();
    renderDetailODJ();
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

async function deleteAgendaItem(id) {
  if (!confirm('Supprimer ce point ?')) return;
  try {
    await deleteRecord('AgendaItems', id);
    await loadAll();
    renderDetailODJ();
    showToast('âœ“ Point supprimÃ©', 'success');
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

async function saveAgendaSummary(id, val) {
  try { await updateRecord('AgendaItems', id, { summary: val }); const i = STATE.agendaItems.find(a=>a.id===id); if(i) i.summary=val; }
  catch(e) { showToast('Erreur sauvegarde', 'error'); }
}
async function saveAgendaDecision(id, val) {
  try { await updateRecord('AgendaItems', id, { decision: val }); const i = STATE.agendaItems.find(a=>a.id===id); if(i) i.decision=val; }
  catch(e) { showToast('Erreur sauvegarde', 'error'); }
}

function toggleAgenda(id) {
  document.getElementById('agenda-' + id)?.classList.toggle('expanded');
}

function openNewActionModal(agendaItemId) {
  STATE.editActionId = null;
  document.getElementById('modal-action-title').textContent = 'Nouvelle action';
  document.getElementById('fac-title').value = '';
  document.getElementById('fac-assignee').value = '';
  document.getElementById('fac-due').value = '';
  document.getElementById('fac-priority').value = 'Moyenne';
  document.getElementById('fac-status').value = 'Ã€ faire';
  document.getElementById('fac-progress').value = 0;
  document.getElementById('fac-pct-label').textContent = '0';
  document.getElementById('fac-notes').value = '';
  // Populate agenda items
  const items = STATE.agendaItems.filter(a => a.meeting_id === STATE.currentMeetingId);
  const sel = document.getElementById('fac-agenda-item');
  sel.innerHTML = `<option value="">â€” Aucun â€”</option>` + items.map(i => `<option value="${i.id}" ${i.id===agendaItemId?'selected':''}>${i.order_num}. ${i.title}</option>`).join('');
  openModal('modal-action');
}

function editAction(id) {
  const a = STATE.actionItems.find(x => x.id === id);
  if (!a) return;
  STATE.editActionId = id;
  STATE.currentMeetingId = a.meeting_id || STATE.currentMeetingId;
  document.getElementById('modal-action-title').textContent = 'Modifier l\'action';
  document.getElementById('fac-title').value = a.title || '';
  document.getElementById('fac-assignee').value = a.assignee || '';
  document.getElementById('fac-due').value = fmtDateInput(a.due_date);
  document.getElementById('fac-priority').value = a.priority || 'Moyenne';
  document.getElementById('fac-status').value = a.status || 'Ã€ faire';
  document.getElementById('fac-progress').value = a.progress_pct || 0;
  document.getElementById('fac-pct-label').textContent = a.progress_pct || 0;
  document.getElementById('fac-notes').value = a.notes || '';
  const items = STATE.agendaItems.filter(ai => ai.meeting_id === STATE.currentMeetingId);
  const sel = document.getElementById('fac-agenda-item');
  sel.innerHTML = `<option value="">â€” Aucun â€”</option>` + items.map(i => `<option value="${i.id}" ${i.id===a.agenda_item_id?'selected':''}>${i.order_num}. ${i.title}</option>`).join('');
  openModal('modal-action');
}

async function saveAction() {
  const agendaSel = parseInt(document.getElementById('fac-agenda-item').value) || null;
  const agendaItem = agendaSel ? STATE.agendaItems.find(a => a.id === agendaSel) : null;
  const meetingId = agendaItem?.meeting_id || STATE.currentMeetingId || null;
  const fields = {
    title:         document.getElementById('fac-title').value.trim(),
    assignee:      document.getElementById('fac-assignee').value.trim(),
    due_date:      dateToGrist(document.getElementById('fac-due').value),
    priority:      document.getElementById('fac-priority').value,
    status:        document.getElementById('fac-status').value,
    progress_pct:  parseInt(document.getElementById('fac-progress').value),
    notes:         document.getElementById('fac-notes').value,
    agenda_item_id: agendaSel,
    meeting_id:    meetingId,
  };
  if (!fields.title) { showToast('La description est obligatoire', 'error'); return; }
  try {
    if (STATE.editActionId) {
      await updateRecord('ActionItems', STATE.editActionId, fields);
      showToast('âœ“ Action modifiÃ©e', 'success');
    } else {
      await addRecord('ActionItems', fields);
      showToast('âœ“ Action crÃ©Ã©e', 'success');
    }
    closeModal('modal-action');
    await loadAll();
    if (STATE.currentDetailTab === 'actions-detail') renderDetailActions();
    if (STATE.currentDetailTab === 'odj') renderDetailODJ();
    renderActionsPanel();
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

async function deleteAction(id) {
  if (!confirm('Supprimer cette action ?')) return;
  try {
    await deleteRecord('ActionItems', id);
    await loadAll();
    renderDetailActions();
    renderActionsPanel();
    showToast('âœ“ Action supprimÃ©e', 'success');
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

async function toggleCRValidated(val) {
  if (!STATE.currentMeetingId) return;
  try {
    await updateRecord('Meetings', STATE.currentMeetingId, { minutes_validated: val });
    const m = STATE.meetings.find(x => x.id === STATE.currentMeetingId);
    if (m) m.minutes_validated = val;
    showToast(val ? 'âœ“ CR marquÃ© comme validÃ©' : 'CR marquÃ© non validÃ©', 'success');
  } catch(e) { showToast('Erreur', 'error'); }
}

function openParticipantModal() {
  document.getElementById('fp-name').value = '';
  document.getElementById('fp-email').value = '';
  document.getElementById('fp-role').value = 'InvitÃ©';
  document.getElementById('fp-present').value = '1';
  openModal('modal-participant');
}

async function saveParticipant() {
  const fields = {
    meeting_id: STATE.currentMeetingId,
    name:    document.getElementById('fp-name').value.trim(),
    email:   document.getElementById('fp-email').value.trim(),
    role:    document.getElementById('fp-role').value,
    present: document.getElementById('fp-present').value === '1',
  };
  if (!fields.name) { showToast('Le nom est obligatoire', 'error'); return; }
  try {
    await addRecord('Participants', fields);
    closeModal('modal-participant');
    await loadAll();
    renderDetailParticipants();
    showToast('âœ“ Participant ajoutÃ©', 'success');
  } catch(e) { showToast('Erreur : ' + e.message, 'error'); }
}

async function deleteParticipant(id) {
  if (!confirm('Supprimer ce participant ?')) return;
  try {
    await deleteRecord('Participants', id);
    await loadAll();
    renderDetailParticipants();
    showToast('âœ“ SupprimÃ©', 'success');
  } catch(e) { showToast('Erreur', 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimeout;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = type;
  t.style.display = 'flex';
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => { t.style.display = 'none'; }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃ‰MARRAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// Lancer l'initialisation
initWidget();
</script>
</body>
</html>
